# æ•…éšœæ’æŸ¥ä¸è°ƒè¯•

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [WRONG-ANSWERS-AI-TROUBLESHOOTING.md](file://documents/WRONG-ANSWERS-AI-TROUBLESHOOTING.md)
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts)
- [metrics/route.ts](file://app/api/performance/metrics/route.ts)
- [kokoro-service-enhanced.ts](file://lib/kokoro-service-enhanced.ts)
- [tts-service.ts](file://lib/tts-service.ts)
- [i18n/performance.ts](file://lib/i18n/performance.ts)
- [bilingual-example.tsx](file://components/examples/bilingual-example.tsx)
- [CACHE_TROUBLESHOOTING.md](file://CACHE_TROUBLESHOOTING.md)
- [SPACY_MODEL_FIX.md](file://documents/SPACY_MODEL_FIX.md)
- [Dockerfile](file://Dockerfile)
- [kokoro_wrapper.py](file://kokoro_local/kokoro_wrapper.py) - *é‡æ„äº†TTSåŒ…è£…å™¨ï¼Œå¢å¼ºäº†ç¦»çº¿æ¨¡å¼å’Œè·¯å¾„è§£æ*
- [kokoro-env.ts](file://lib/kokoro-env.ts) - *é‡æ„äº†TTSåŒ…è£…å™¨ï¼Œå¢å¼ºäº†ç¦»çº¿æ¨¡å¼å’Œè·¯å¾„è§£æ*
- [cerebras-client-manager.ts](file://lib/ai/cerebras-client-manager.ts) - *æ–°å¢ï¼ŒAIä»£ç†ç®¡ç†ä¸å¥åº·æ£€æŸ¥*
- [retry-strategy.ts](file://lib/ai/retry-strategy.ts) - *æ–°å¢ï¼Œç»“æ„åŒ–é‡è¯•ç­–ç•¥ä¸è¦†ç›–ç‡è¯„ä¼°*
- [cerebras-service.ts](file://lib/ai/cerebras-service.ts) - *æ–°å¢ï¼Œç»Ÿä¸€çš„ç»“æ„åŒ–è°ƒç”¨ç®¡é“*
- [project-board.md](file://documents/project-board.md) - *å·²ç§»é™¤åŠ¨æ€ä»£ç†æ”¯æŒ*
- [project-status.md](file://documents/project-status.md) - *å·²ç§»é™¤åŠ¨æ€ä»£ç†æ”¯æŒ*
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts) - *æ–°å¢ï¼Œæ”¯æŒHTTP Rangeè¯·æ±‚*
- [audio-utils.ts](file://lib/audio-utils.ts) - *æ–°å¢ï¼ŒéŸ³é¢‘å…ƒæ•°æ®è§£æä¸ç¼“å­˜*
</cite>

## æ›´æ–°æ‘˜è¦
- **æ–°å¢** **éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ** ç« èŠ‚ï¼Œæ¶µç›–æ”¯æŒHTTP Rangeè¯·æ±‚çš„å®ç°ç»†èŠ‚å’Œæ–­ç‚¹ç»­æ’­åŠŸèƒ½
- **æ›´æ–°** **éŸ³é¢‘æ’­æ”¾å¼‚å¸¸** éƒ¨åˆ†ï¼Œå¢åŠ å¯¹Rangeè¯·æ±‚å¤„ç†å’ŒéŸ³é¢‘å…ƒæ•°æ®è§£æçš„è¯´æ˜
- **æ›´æ–°** **æ—¥å¿—åˆ†ææŠ€å·§** éƒ¨åˆ†ï¼Œå¢åŠ ä¸éŸ³é¢‘æµå¤„ç†ç›¸å…³çš„æ—¥å¿—æ¨¡å¼
- **æ–°å¢** **éŸ³é¢‘æµå¤„ç†æœºåˆ¶** ç« èŠ‚ï¼Œè¯¦ç»†è¯´æ˜Rangeè¯·æ±‚è§£æå’Œéƒ¨åˆ†å“åº”çš„å®ç°
- **æ›´æ–°** æ–‡æ¡£å¼•ç”¨æ–‡ä»¶åˆ—è¡¨ï¼ŒåŒ…å«æ–°åˆ†æçš„`audio/[filename]/route.ts`å’Œ`audio-utils.ts`æ–‡ä»¶

## ç›®å½•
1. [å¸¸è§é—®é¢˜è¯Šæ–­](#å¸¸è§é—®é¢˜è¯Šæ–­)
2. [TTSå¼•æ“æ•…éšœæ’æŸ¥](#ttså¼•æ“æ•…éšœæ’æŸ¥)
3. [AIæ¥å£è¶…æ—¶å¤„ç†](#aiæ¥å£è¶…æ—¶å¤„ç†)
4. [éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ](#éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ)
5. [åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±è§£å†³](#åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±è§£å†³)
6. [è¿œç¨‹è°ƒè¯•å·¥å…·ä½¿ç”¨](#è¿œç¨‹è°ƒè¯•å·¥å…·ä½¿ç”¨)
7. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
8. [æ€§èƒ½ç›‘æ§æŒ‡æ ‡](#æ€§èƒ½ç›‘æ§æŒ‡æ ‡)
9. [æ—¥å¿—åˆ†ææŠ€å·§](#æ—¥å¿—åˆ†ææŠ€å·§)
10. [TTSåŒ…è£…å™¨é‡æ„å½±å“](#ttsåŒ…è£…å™¨é‡æ„å½±å“)
11. [ç¼“å­˜å±‚éªŒè¯è„šæœ¬](#ç¼“å­˜å±‚éªŒè¯è„šæœ¬)
12. [AIæœåŠ¡è°ƒç”¨ç®¡é“é‡æ„å½±å“](#aiæœåŠ¡è°ƒç”¨ç®¡é“é‡æ„å½±å“)
13. [éŸ³é¢‘æµå¤„ç†æœºåˆ¶](#éŸ³é¢‘æµå¤„ç†æœºåˆ¶)

## å¸¸è§é—®é¢˜è¯Šæ–­

### TTSå¼•æ“å¯åŠ¨å¤±è´¥

#### ç—‡çŠ¶ï¼šTTSæœåŠ¡æ— æ³•å¯åŠ¨æˆ–åˆå§‹åŒ–å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- Pythonç¯å¢ƒé…ç½®é—®é¢˜
- GPUé©±åŠ¨æˆ–CUDAæœªæ­£ç¡®å®‰è£…
- æ¨¡å‹æ–‡ä»¶ç¼ºå¤±æˆ–æŸå
- ç³»ç»Ÿèµ„æºä¸è¶³ï¼ˆå†…å­˜ã€æ˜¾å­˜ï¼‰
- ä¾èµ–åº“ç‰ˆæœ¬å†²çª
- SpaCyæ¨¡å‹è¿è¡Œæ—¶ä¸‹è½½å¤±è´¥ï¼ˆç½‘ç»œé™åˆ¶ï¼‰
- **æ–°å¢**ï¼šç¦»çº¿æ¨¡å¼ä¸‹æ¨¡å‹è·¯å¾„é…ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥Pythonç¯å¢ƒ**
   ```bash
   # éªŒè¯Pythonç‰ˆæœ¬
   python --version
   
   # æ£€æŸ¥å…³é”®æ¨¡å—
   python -c "import torch, phonemizer, espeakng_loader"
   ```

2. **éªŒè¯GPUæ”¯æŒ**
   ```bash
   # æ£€æŸ¥CUDAå¯ç”¨æ€§
   python -c "import torch; print(torch.cuda.is_available())"
   
   # æŸ¥çœ‹GPUè®¾å¤‡ä¿¡æ¯
   nvidia-smi
   ```

3. **æ£€æŸ¥æ¨¡å‹æ–‡ä»¶**
   ```bash
   # éªŒè¯TTSæ¨¡å‹ç›®å½•
   ls -la kokoro-main-ref/models/
   
   # æ£€æŸ¥espeak-ngæ•°æ®è·¯å¾„
   python -c "from espeakng_loader import get_data_path; print(get_data_path())"
   
   # **æ–°å¢**ï¼šæ£€æŸ¥ç¦»çº¿æ¨¡å‹è·¯å¾„
   ls -la kokoro-models/Kokoro-82M/
   ls -la ~/.cache/huggingface/hub/models--hexgrad--Kokoro-82M/
   ```

4. **æŸ¥çœ‹ç³»ç»Ÿèµ„æº**
   ```bash
   # æ£€æŸ¥å†…å­˜ä½¿ç”¨
   free -h
   
   # æ£€æŸ¥ç£ç›˜ç©ºé—´
   df -h
   ```

**ç« èŠ‚æ¥æº**
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)
- [kokoro-service-enhanced.ts](file://lib/kokoro-service-enhanced.ts#L83-L121)
- [kokoro_wrapper.py](file://kokoro_local/kokoro_wrapper.py#L150-L250) - *æ–°å¢ï¼Œç¦»çº¿æ¨¡å¼åˆå§‹åŒ–é€»è¾‘*

### AIæ¥å£è¶…æ—¶

#### ç—‡çŠ¶ï¼šAIåˆ†æè¯·æ±‚è¶…æ—¶æˆ–å“åº”ç¼“æ…¢

**å¯èƒ½åŸå› ï¼š**
- Cerebras APIæœåŠ¡ä¸å¯ç”¨
- ç½‘ç»œè¿æ¥é—®é¢˜
- **å·²ç§»é™¤**ï¼šä»£ç†é…ç½®é”™è¯¯ï¼ˆåŠ¨æ€ä»£ç†æ”¯æŒå·²ç§»é™¤ï¼‰
- è¯·æ±‚é¢‘ç‡è¶…è¿‡é™åˆ¶
- è¾“å…¥æ–‡æœ¬è¿‡é•¿

**è§£å†³æ–¹æ¡ˆï¼š**

1. **éªŒè¯APIè¿æ¥**
   ```bash
   # æµ‹è¯•APIå¯†é’¥æœ‰æ•ˆæ€§
   curl -H "Authorization: Bearer $CEREBRAS_API_KEY" \
        https://api.cerebras.ai/v1/models
   
   # æµ‹è¯•ç½‘ç»œè¿é€šæ€§
   curl -I https://api.cerebras.ai
   ```

2. **è°ƒæ•´å¹¶å‘è®¾ç½®**
   ```typescript
   // å‡å°‘å¹¶å‘è¯·æ±‚æ•°
   const limit = pLimit(5); // é»˜è®¤ä¸º10
   
   // æ‰¹é‡å¤„ç†åˆ†å—
   const chunkSize = 20;
   ```

3. **å®ç°é‡è¯•æœºåˆ¶**
   ```typescript
   // ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
   const retryDelay = Math.min(1000 * Math.pow(2, attempt), 10000);
   ```

**ç« èŠ‚æ¥æº**
- [WRONG-ANSWERS-AI-TROUBLESHOOTING.md](file://documents/WRONG-ANSWERS-AI-TROUBLESHOOTING.md)
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L298-L337)

### éŸ³é¢‘æ’­æ”¾å¼‚å¸¸

#### ç—‡çŠ¶ï¼šéŸ³é¢‘æ— æ³•æ’­æ”¾æˆ–æ’­æ”¾ä¸­æ–­

**å¯èƒ½åŸå› ï¼š**
- éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆå¤±è´¥
- æ–‡ä»¶æ ¼å¼ä¸å…¼å®¹
- ç½‘ç»œä¼ è¾“é—®é¢˜
- æµè§ˆå™¨ç¼“å­˜é—®é¢˜
- **æ–°å¢**ï¼šä¸æ”¯æŒRangeè¯·æ±‚çš„å®¢æˆ·ç«¯å…¼å®¹æ€§é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶**
   ```bash
   # éªŒè¯éŸ³é¢‘ç›®å½•
   ls -la public/audio/
   
   # æ£€æŸ¥æ–‡ä»¶æƒé™
   chmod -R 755 public/audio/
   ```

2. **éªŒè¯æ–‡ä»¶æ ¼å¼**
   ```typescript
   // æ”¯æŒçš„æ ¼å¼åŒ…æ‹¬WAVå’ŒMP3
   export function validateAudioFormat(buffer: Buffer) {
     const format = detectAudioFormat(buffer);
     return { isValid: ['wav', 'mp3'].includes(format), format };
   }
   ```

3. **æ¸…ç†æ—§æ–‡ä»¶**
   ```bash
   # åˆ é™¤7å¤©å‰çš„éŸ³é¢‘æ–‡ä»¶
   find public/ -name "*.wav" -mtime +7 -delete
   ```

4. **æ£€æŸ¥Rangeè¯·æ±‚æ”¯æŒ**
   ```bash
   # æµ‹è¯•Rangeè¯·æ±‚
   curl -H "Range: bytes=0-1023" http://localhost:3000/tts_audio_1.wav -v
   ```

**ç« èŠ‚æ¥æº**
- [tts-service.ts](file://lib/tts-service.ts#L49-L66)
- [audio-utils.ts](file://lib/audio-utils.ts#L239-L264)
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L67-L134) - *æ–°å¢ï¼ŒRangeè¯·æ±‚å¤„ç†*

### åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±

#### ç—‡çŠ¶ï¼šä¸­è‹±æ–‡æ–‡æœ¬æ˜¾ç¤ºé¡ºåºæ··ä¹±æˆ–å†…å®¹ç¼ºå¤±

**å¯èƒ½åŸå› ï¼š**
- å›½é™…åŒ–é…ç½®é”™è¯¯
- ç¼“å­˜å¤±æ•ˆ
- ç»„ä»¶æ¸²æŸ“é—®é¢˜
- æ•°æ®æ ¼å¼ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥å›½é™…åŒ–é…ç½®**
   ```typescript
   // éªŒè¯ç¿»è¯‘èµ„æº
   import translations from '@/lib/i18n/translations/components.json';
   
   // æ£€æŸ¥åŒè¯­ç»„ä»¶ä½¿ç”¨
   <BilingualText translationKey="common:buttons.generate" />
   ```

2. **æ¸…é™¤ç¼“å­˜**
   ```bash
   # æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   # å¼€å‘è€…å·¥å…· -> Application -> Clear site data
   ```

3. **éªŒè¯æ•°æ®ç»“æ„**
   ```json
   {
     "en": "Generate",
     "zh": "ç”Ÿæˆ"
   }
   ```

**ç« èŠ‚æ¥æº**
- [bilingual-example.tsx](file://components/examples/bilingual-example.tsx)
- [i18n/types.ts](file://lib/i18n/types.ts#L46-L106)

## TTSå¼•æ“æ•…éšœæ’æŸ¥

### å¯åŠ¨æµç¨‹åˆ†æ

```mermaid
flowchart TD
Start([å¯åŠ¨TTSæœåŠ¡]) --> CheckEnv["æ£€æŸ¥Pythonç¯å¢ƒ"]
CheckEnv --> EnvValid{"ç¯å¢ƒæ­£å¸¸?"}
EnvValid --> |å¦| FixEnv["ä¿®å¤ç¯å¢ƒé…ç½®"]
EnvValid --> |æ˜¯| CheckOfflineMode["æ£€æŸ¥ç¦»çº¿æ¨¡å¼"]
CheckOfflineMode --> OfflineValid{"ç¦»çº¿æ¨¡å¼é…ç½®æ­£ç¡®?"}
OfflineValid --> |å¦| FixOffline["é…ç½®ç¦»çº¿æ¨¡å‹è·¯å¾„"]
OfflineValid --> |æ˜¯| LoadModels["åŠ è½½TTSæ¨¡å‹"]
LoadModels --> ModelsLoaded{"æ¨¡å‹åŠ è½½æˆåŠŸ?"}
ModelsLoaded --> |å¦| CheckModelPath["æ£€æŸ¥æ¨¡å‹è·¯å¾„"]
ModelsLoaded --> |æ˜¯| InitService["åˆå§‹åŒ–æœåŠ¡"]
InitService --> ServiceReady{"æœåŠ¡å°±ç»ª?"}
ServiceReady --> |å¦| RestartService["é‡å¯æœåŠ¡"]
ServiceReady --> |æ˜¯| End([æœåŠ¡å¯åŠ¨æˆåŠŸ])
FixEnv --> CheckEnv
FixOffline --> CheckOffline
CheckModelPath --> LoadModels
RestartService --> InitService
```

**å›¾ç¤ºæ¥æº**
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)
- [kokoro-service-enhanced.ts](file://lib/kokoro-service-enhanced.ts#L83-L121)
- [kokoro_wrapper.py](file://kokoro_local/kokoro_wrapper.py#L150-L250) - *æ–°å¢ï¼Œç¦»çº¿æ¨¡å¼æµç¨‹*

### é”™è¯¯æ¢å¤æœºåˆ¶

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Initializing : "å¼€å§‹åˆå§‹åŒ–"
Initializing --> Ready : "åˆå§‹åŒ–æˆåŠŸ"
Initializing --> Error : "åˆå§‹åŒ–å¤±è´¥"
Ready --> Processing : "æ¥æ”¶è¯·æ±‚"
Processing --> Ready : "å¤„ç†å®Œæˆ"
Processing --> Error : "å¤„ç†å¤±è´¥"
Error --> Recovering : "å°è¯•æ¢å¤"
Recovering --> Initializing : "é‡æ–°åˆå§‹åŒ–"
Recovering --> Shutdown : "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
Shutdown --> [*]
```

**å›¾ç¤ºæ¥æº**
- [enhanced-tts-service.ts](file://lib/enhanced-tts-service.ts#L424-L467)
- [kokoro-service-gpu.ts](file://lib/kokoro-service-gpu.ts#L280-L318)

## AIæ¥å£è¶…æ—¶å¤„ç†

### è¶…æ—¶é‡è¯•ç­–ç•¥

```mermaid
flowchart LR
Request --> RetryCount["é‡è¯•è®¡æ•°=0"]
RetryCount --> MaxAttempts{"è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°?"}
MaxAttempts --> |å¦| Wait["ç­‰å¾…å»¶è¿Ÿæ—¶é—´"]
Wait --> CallAPI["è°ƒç”¨AIæ¥å£"]
CallAPI --> Success{"è°ƒç”¨æˆåŠŸ?"}
Success --> |æ˜¯| ReturnResult["è¿”å›ç»“æœ"]
Success --> |å¦| IncreaseRetry["é‡è¯•è®¡æ•°++"]
IncreaseRetry --> Backoff["è®¡ç®—é€€é¿æ—¶é—´"]
Backoff --> Wait
MaxAttempts --> |æ˜¯| ReturnError["è¿”å›é”™è¯¯"]
style Wait fill:#f9f,stroke:#333
style CallAPI fill:#bbf,stroke:#333
```

**å›¾ç¤ºæ¥æº**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L270-L393)
- [rate-limiter.ts](file://lib/rate-limiter.ts#L215-L276)

## éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ

### éŸ³é¢‘ç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
participant UI as "ç”¨æˆ·ç•Œé¢"
participant Player as "éŸ³é¢‘æ’­æ”¾å™¨"
participant Service as "TTSæœåŠ¡"
participant Storage as "å­˜å‚¨ç³»ç»Ÿ"
UI->>Player : è¯·æ±‚æ’­æ”¾éŸ³é¢‘
Player->>Storage : æ£€æŸ¥æœ¬åœ°ç¼“å­˜
alt ç¼“å­˜å­˜åœ¨
Storage-->>Player : è¿”å›éŸ³é¢‘æ–‡ä»¶
else ç¼“å­˜ä¸å­˜åœ¨
Player->>Service : è¯·æ±‚ç”ŸæˆéŸ³é¢‘
Service->>Service : å¤„ç†æ–‡æœ¬è½¬è¯­éŸ³
Service-->>Player : è¿”å›éŸ³é¢‘URL
Player->>Storage : ç¼“å­˜éŸ³é¢‘æ–‡ä»¶
end
Player->>UI : å¼€å§‹æ’­æ”¾
loop æ’­æ”¾è¿‡ç¨‹
Player->>UI : æ›´æ–°æ’­æ”¾è¿›åº¦
end
Player->>UI : æ’­æ”¾å®Œæˆ
```

**å›¾ç¤ºæ¥æº**
- [tts-service.ts](file://lib/tts-service.ts#L68-L98)
- [optimized-audio-player.tsx](file://components/optimized-audio-player.tsx#L299-L325)

## åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±è§£å†³

### å›½é™…åŒ–æ€§èƒ½ç›‘æ§

```mermaid
classDiagram
class I18nPerformanceMonitor {
-metrics : PerformanceMetrics
-translationTimes : number[]
-startTime : number
+startTranslation()
+endTranslation()
+recordCacheHit(type)
+recordCacheMiss(type)
+updateMemoryUsage(size)
+setTranslationLoadTime(time)
+getMetrics()
+getCacheHitRatios()
+reset()
+logPerformanceSummary()
}
class PerformanceMetrics {
+translationCacheHits : number
+translationCacheMisses : number
+formatCacheHits : number
+formatCacheMisses : number
+translationLoadTime : number
+averageTranslationTime : number
+memoryUsage : object
}
I18nPerformanceMonitor --> PerformanceMetrics : "åŒ…å«"
```

**å›¾ç¤ºæ¥æº**
- [i18n/performance.ts](file://lib/i18n/performance.ts#L17-L136)
- [enablePerformanceLogging](file://lib/i18n/performance.ts#L142-L149)

## è¿œç¨‹è°ƒè¯•å·¥å…·ä½¿ç”¨

### debug-kokoro-remote.pyä½¿ç”¨æŒ‡å—

è¯¥è„šæœ¬ç”¨äºæ’æŸ¥misaki/espeakå…¼å®¹æ€§é—®é¢˜ï¼Œæä¾›å…¨é¢çš„ç¯å¢ƒæ£€æŸ¥åŠŸèƒ½ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- Pythonç‰ˆæœ¬æ£€æŸ¥
- å…³é”®æ¨¡å—å¯¼å…¥æµ‹è¯•
- EspeakWrapperæ–¹æ³•éªŒè¯
- misaki.espeakç‰¹å®šé…ç½®æµ‹è¯•
- Kokoroå¯¼å…¥å’Œå®ä¾‹åŒ–æµ‹è¯•
- CUDAå¯ç”¨æ€§æ£€æµ‹

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
python scripts/debug-kokoro-remote.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
=== Kokoro TTS è¿œç¨‹è°ƒè¯• ===
Pythonç‰ˆæœ¬: 3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0]
âœ“ torch - å¯¼å…¥æˆåŠŸ
âœ“ phonemizer - å¯¼å…¥æˆåŠŸ
âœ“ espeakng_loader - å¯¼å…¥æˆåŠŸ
âœ“ misaki - å¯¼å…¥æˆåŠŸ
âœ“ misaki.espeak - å¯¼å…¥æˆåŠŸ
âœ“ EspeakWrapperå¯ç”¨æ–¹æ³•: [set_library, set_data_path, __init__, ...]
âœ“ æœ‰set_data_pathæ–¹æ³•: True
âœ“ espeakngåº“è·¯å¾„: /usr/lib/x86_64-linux-gnu/libespeak-ng.so.1
âœ“ espeakngæ•°æ®è·¯å¾„: /usr/share/espeak-ng-data
âœ“ EspeakWrapperé…ç½®æˆåŠŸ
=== æµ‹è¯•Kokoroå¯¼å…¥ ===
âœ“ KPipelineå¯¼å…¥æˆåŠŸ
âœ“ KPipelineåˆ›å»ºæˆåŠŸ
=== æµ‹è¯•CUDA ===
âœ“ CUDAå¯ç”¨: True
âœ“ CUDAè®¾å¤‡æ•°é‡: 1
âœ“ å½“å‰CUDAè®¾å¤‡: 0
âœ“ è®¾å¤‡åç§°: NVIDIA GeForce RTX 3090
```

**ç« èŠ‚æ¥æº**
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)

## é”™è¯¯å¤„ç†æœºåˆ¶

### å¢å¼ºå‹é”™è¯¯å¤„ç†å™¨

```mermaid
classDiagram
class AppError {
+message : string
+context : ErrorContext
+originalError? : Error
+toResponse() : NextResponse
+getStatusCode() : number
+getUserMessage() : string
}
class ErrorContext {
+type : ErrorType
+severity : ErrorSeverity
+component? : string
+userId? : string
+operation? : string
+metadata? : Record<string, unknown>
}
class ErrorMonitor {
-errorCounts : Map<string, number>
-lastErrors : Map<string, Date>
-circuitBreakers : Map<string, CircuitBreakerState>
+recordError(context, error)
+isCircuitBreakerOpen(key)
+recordSuccess(key)
+getErrorStats()
}
class OperationCanceller {
-controllers : Map<string, AbortController>
+createOperation(id)
+cancelOperation(id)
+cancelAllOperations()
+isOperationCancelled(id)
}
AppError --> ErrorContext
ErrorMonitor --> AppError : "è®°å½•"
OperationCanceller --> AppError : "å–æ¶ˆ"
```

**å›¾ç¤ºæ¥æº**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L270-L393)
- [ErrorMonitor](file://lib/enhanced-error-handler.ts#L147-L270)

### é”™è¯¯ç±»å‹åˆ†ç±»

| é”™è¯¯ç±»å‹ | HTTPçŠ¶æ€ç  | ç”¨æˆ·æç¤º | ä¸¥é‡ç¨‹åº¦ |
|---------|----------|--------|--------|
| VALIDATION | 400 | è¾“å…¥æ•°æ®æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯• | ä½ |
| DATABASE | 500 | æ•°æ®è®¿é—®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯• | é«˜ |
| TTS_SERVICE | 503 | è¯­éŸ³æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• | é«˜ |
| AI_SERVICE | 503 | AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• | é«˜ |
| NETWORK | 500 | ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯• | ä¸­ |
| RATE_LIMIT | 429 | æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯• | ä¸­ |
| RESOURCE | 500 | ç³»ç»Ÿèµ„æºä¸è¶³ï¼Œè¯·ç¨åé‡è¯• | é«˜ |

**ç« èŠ‚æ¥æº**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L298-L337)

## æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### performance/metrics API

è¯¥APIæä¾›ç³»ç»Ÿæ€§èƒ½ç›‘æ§æ•°æ®ï¼Œå¯ç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿè´Ÿè½½ã€‚

**ç«¯ç‚¹ï¼š** `/api/performance/metrics`

**è¿”å›æ•°æ®ç»“æ„ï¼š**
```json
{
  "success": true,
  "detailed": {
    "performanceHistory": [
      {
        "latest": 95,
        "trend": "improving",
        "reliability": "high"
      }
    ],
    "resourceUtilization": {
      "cpu": 45.2,
      "memory": 67.8,
      "disk": 32.1
    },
    "errorRates": {
      "tts": 0.02,
      "ai": 0.05,
      "database": 0.01
    }
  }
}
```

**å…³é”®æŒ‡æ ‡ï¼š**
- `api_request_duration`: APIè¯·æ±‚æŒç»­æ—¶é—´
- `memory_rss`: å†…å­˜å¸¸é©»é›†å¤§å°
- `memory_heap_used`: å †å†…å­˜ä½¿ç”¨é‡
- `database_operation_duration`: æ•°æ®åº“æ“ä½œæŒç»­æ—¶é—´
- `build_cache_hit_rate`: æ„å»ºç¼“å­˜å‘½ä¸­ç‡
- `build_cache_restore_time`: æ„å»ºç¼“å­˜æ¢å¤æ—¶é—´

```mermaid
graph TB
subgraph "ç›‘æ§æŒ‡æ ‡"
A[APIè¯·æ±‚æ—¶é•¿]
B[å†…å­˜ä½¿ç”¨]
C[æ•°æ®åº“æ€§èƒ½]
D[é”™è¯¯ç‡]
E[æ„å»ºç¼“å­˜æ€§èƒ½]
end
subgraph "æ•°æ®é‡‡é›†"
F[recordMetric]
G[startRequest]
H[endRequest]
I[recordMemoryUsage]
J[recordDatabaseMetric]
K[recordBuildCacheMetric]
end
subgraph "æ•°æ®åˆ†æ"
L[getMetricStats]
M[getRecentMetrics]
N[getActiveRequestCount]
O[getBuildCacheStats]
end
F --> A
G --> A
H --> A
I --> B
J --> C
K --> E
L --> D
M --> D
N --> A
O --> E
```

**å›¾ç¤ºæ¥æº**
- [metrics/route.ts](file://app/api/performance/metrics/route.ts#L75-L82)
- [monitoring.ts](file://lib/monitoring.ts#L270-L393)
- [CACHE_TROUBLESHOOTING.md](file://CACHE_TROUBLESHOOTING.md)

## æ—¥å¿—åˆ†ææŠ€å·§

### å…³é”®æ—¥å¿—æ¨¡å¼

**TTSæœåŠ¡ç›¸å…³æ—¥å¿—ï¼š**
- `ğŸš€ Initializing Kokoro TTS service...` - æœåŠ¡å¼€å§‹åˆå§‹åŒ–
- `âœ… Kokoro TTS service initialized successfully` - æœåŠ¡åˆå§‹åŒ–æˆåŠŸ
- `ğŸ”¥ TTS service process error:` - TTSè¿›ç¨‹é”™è¯¯
- `ğŸ”„ Restarting TTS service` - æœåŠ¡é‡å¯å°è¯•
- `âŒ Max restart attempts reached` - è¾¾åˆ°æœ€å¤§é‡å¯æ¬¡æ•°
- **æ–°å¢**ï¼š`âŒ Kokoro model not found in offline mode.` - ç¦»çº¿æ¨¡å¼ä¸‹æ¨¡å‹æœªæ‰¾åˆ°

**AIæœåŠ¡ç›¸å…³æ—¥å¿—ï¼š**
- `Network connectivity issues with Cerebras API` - ç½‘ç»œè¿æ¥é—®é¢˜
- `Rate limiting exceeded for AI service` - è¶…å‡ºé€Ÿç‡é™åˆ¶
- `AI analysis generation failed` - AIåˆ†æç”Ÿæˆå¤±è´¥
- **æ–°å¢**ï¼š`AI call attempt X failed` - AIè°ƒç”¨é‡è¯•
- **æ–°å¢**ï¼š`Executing coverage retry attempt X` - æ‰§è¡Œè¦†ç›–ç‡é‡è¯•
- **æ–°å¢**ï¼š`Cerebras health check passed` - Cerebraså¥åº·æ£€æŸ¥é€šè¿‡

**æ•°æ®åº“ç›¸å…³æ—¥å¿—ï¼š**
- `SQLITE_BUSY database is locked` - æ•°æ®åº“é”å®š
- `Database migration applied successfully` - æ•°æ®åº“è¿ç§»æˆåŠŸ
- `Slow query detected: SELECT * FROM ...` - æ£€æµ‹åˆ°æ…¢æŸ¥è¯¢

**éŸ³é¢‘æµç›¸å…³æ—¥å¿—ï¼š**
- `Serving audio file: tts_audio_*.wav` - å¼€å§‹æä¾›éŸ³é¢‘æ–‡ä»¶
- `Partial content requested: bytes=X-Y` - æ”¶åˆ°éƒ¨åˆ†è¯·æ±‚
- `Invalid range header: ${range}` - æ— æ•ˆçš„Rangeå¤´
- `Audio file not found: ${filePath}` - éŸ³é¢‘æ–‡ä»¶æœªæ‰¾åˆ°
- `Error serving audio file: ${error}` - æä¾›éŸ³é¢‘æ–‡ä»¶æ—¶å‡ºé”™

### æ—¥å¿—çº§åˆ«è¯´æ˜

| æ—¥å¿—çº§åˆ« | é¢œè‰²æ ‡è¯† | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|
| ğŸš¨ CRITICAL | çº¢è‰² | ç³»ç»Ÿå´©æºƒã€æœåŠ¡ä¸å¯ç”¨ |
| ğŸ”´ HIGH | çº¢è‰² | ä¸¥é‡é”™è¯¯ã€æ•°æ®ä¸¢å¤±é£é™© |
| ğŸŸ¡ MEDIUM | é»„è‰² | å¯æ¢å¤é”™è¯¯ã€è­¦å‘Š |
| ğŸ”µ LOW | è“è‰² | ä¿¡æ¯æ€§æ¶ˆæ¯ã€è°ƒè¯•ä¿¡æ¯ |

**ç« èŠ‚æ¥æº**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L200-L260)
- [WRONG-ANSWERS-AI-TROUBLESHOOTING.md](file://documents/WRONG-ANSWERS-AI-TROUBLESHOOTING.md)
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L67-L134) - *æ–°å¢ï¼ŒéŸ³é¢‘æµæ—¥å¿—*

## TTSåŒ…è£…å™¨é‡æ„å½±å“

### é‡æ„æ¦‚è¿°

`kokoro_local/kokoro_wrapper.py` æ–‡ä»¶ç»è¿‡é‡æ„ï¼Œç»Ÿä¸€äº†åŒ…è£…å™¨é€»è¾‘å¹¶æå–äº†æ–‡æœ¬åˆ†å—æ¨¡å—ï¼Œå¢å¼ºäº†ç¦»çº¿æ¨¡å¼æ”¯æŒå’Œè·¯å¾„è§£æèƒ½åŠ›ã€‚

**ä¸»è¦å˜æ›´ï¼š**
- **ç¦»çº¿æ¨¡å¼å¼ºåˆ¶**ï¼šé€šè¿‡è®¾ç½® `HF_HUB_OFFLINE=1` å’Œ `TRANSFORMERS_OFFLINE=1` ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶åœ¨ç¦»çº¿æ¨¡å¼ä¸‹è¿è¡Œï¼Œé˜²æ­¢è¿è¡Œæ—¶ä¸‹è½½ã€‚
- **å¤šè·¯å¾„æ¨¡å‹æ‰«æ**ï¼šæŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰«æå¤šä¸ªæœ¬åœ°æ¨¡å‹è·¯å¾„ï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡æŒ‡å®šè·¯å¾„ã€é¡¹ç›®æœ¬åœ°ç¼“å­˜ã€ç”¨æˆ·ä¸»ç›®å½•ç¼“å­˜å’Œç‹¬ç«‹æ¨¡å‹ç›®å½•ã€‚
- **è‡ªåŠ¨è·¯å¾„å¤åˆ¶**ï¼šå¦‚æœåœ¨éæ ‡å‡†è·¯å¾„æ‰¾åˆ°æ¨¡å‹ï¼Œä¼šè‡ªåŠ¨å°†å…¶å¤åˆ¶åˆ°HuggingFaceçš„æ ‡å‡†ç¼“å­˜ç»“æ„ä¸­ã€‚
- **è®¾å¤‡è‡ªåŠ¨æ£€æµ‹**ï¼šæ ¹æ®å¹³å°å’Œç¡¬ä»¶è‡ªåŠ¨é€‰æ‹©æœ€ä½³è®¾å¤‡ï¼ˆCUDAã€MPSæˆ–CPUï¼‰ã€‚
- **æ–‡æœ¬æ™ºèƒ½åˆ†å—**ï¼šå¯¹äºé•¿æ–‡æœ¬ï¼Œä½¿ç”¨ `split_text_intelligently` å‡½æ•°è¿›è¡Œåˆ†å—å¤„ç†ï¼Œé¿å…æˆªæ–­ã€‚

**ç« èŠ‚æ¥æº**
- [kokoro_wrapper.py](file://kokoro_local/kokoro_wrapper.py) - *é‡æ„äº†TTSåŒ…è£…å™¨ï¼Œå¢å¼ºäº†ç¦»çº¿æ¨¡å¼å’Œè·¯å¾„è§£æ*
- [kokoro-env.ts](file://lib/kokoro-env.ts) - *é‡æ„äº†TTSåŒ…è£…å™¨ï¼Œå¢å¼ºäº†ç¦»çº¿æ¨¡å¼å’Œè·¯å¾„è§£æ*

### æ•…éšœæ’æŸ¥æ›´æ–°

ç”±äºé‡æ„ï¼ŒTTSå¼•æ“å¯åŠ¨å¤±è´¥çš„æ’æŸ¥æµç¨‹éœ€è¦æ›´æ–°ï¼š

1. **æ£€æŸ¥ç¦»çº¿æ¨¡å¼é…ç½®**
   ```bash
   # æ£€æŸ¥ç¯å¢ƒå˜é‡
   echo $KOKORO_LOCAL_MODEL_PATH
   echo $HF_HUB_OFFLINE
   ```

2. **éªŒè¯æ¨¡å‹è·¯å¾„**
   ```bash
   # æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„æ¨¡å‹è·¯å¾„
   ls -la $KOKORO_LOCAL_MODEL_PATH
   ls -la kokoro_local/.cache/huggingface/hub/models--hexgrad--Kokoro-82M/snapshots/main
   ls -la ~/.cache/huggingface/hub/models--hexgrad--Kokoro-82M/snapshots/main
   ls -la kokoro-models/Kokoro-82M
   ```

3. **æŸ¥çœ‹è¯¦ç»†çš„åˆå§‹åŒ–æ—¥å¿—**
   ```bash
   # åœ¨æ—¥å¿—ä¸­æŸ¥æ‰¾æ¨¡å‹æœç´¢è·¯å¾„
   grep "Searched paths:" debug.log
   grep "Found local model at:" debug.log
   ```

**ç« èŠ‚æ¥æº**
- [kokoro_wrapper.py](file://kokoro_local/kokoro_wrapper.py#L150-L250) - *æ–°å¢ï¼Œç¦»çº¿æ¨¡å¼åˆå§‹åŒ–é€»è¾‘*

## ç¼“å­˜å±‚éªŒè¯è„šæœ¬

### å†å²èƒŒæ™¯

ä¸ºè§£å†³è¿œç¨‹æœåŠ¡å™¨ç¼“å­˜é¢„çƒ­ç¼ºå¤±é—®é¢˜ï¼Œæ›¾åˆ›å»º `scripts/verify-cache-layers.sh` è„šæœ¬ç”¨äºéªŒè¯ç¼“å­˜å±‚çš„å®Œæ•´æ€§ã€‚

**è„šæœ¬åŠŸèƒ½ï¼š**
- æ£€æŸ¥ `cache-base`ã€`cache-python` å’Œ `cache-node` ç¼“å­˜å±‚æ˜¯å¦å­˜åœ¨ã€‚
- æ˜¾ç¤ºæ¯ä¸ªç¼“å­˜å±‚çš„å¤§å°å’Œåˆ›å»ºæ—¶é—´ã€‚
- æä¾›è¯¦ç»†çš„éªŒè¯æŠ¥å‘Šå’Œç£ç›˜ä½¿ç”¨æƒ…å†µã€‚

**éªŒè¯é€»è¾‘ï¼š**
```bash
for layer in "${CACHE_LAYERS[@]}"; do
    echo -n "ğŸ“‹ æ£€æŸ¥ $layer: "
    if docker images --format "table {{.Repository}}:{{.Tag}}" | grep -q "$IMAGE_NAME:$layer"; then
        echo -e "${GREEN}âœ… å·²å­˜åœ¨${NC}"
        SIZE=$(docker images --format "{{.Repository}}:{{.Tag}}\t{{.Size}}" | grep "$IMAGE_NAME:$layer" | awk '{print $2}')
        echo "   ğŸ“ å¤§å°: $SIZE"
    else
        echo -e "${RED}âŒ ç¼ºå¤±${NC}"
        ALL_VALID=false
    fi
done
```

**ç°çŠ¶ï¼š**
è¯¥è„šæœ¬å·²äº2025å¹´10æœˆ13æ—¥å½’æ¡£ï¼Œå…¶åŠŸèƒ½è¢«æ‰‹åŠ¨ `docker images` å‘½ä»¤æ£€æŸ¥æ‰€å–ä»£ã€‚å½“å‰éƒ¨ç½²æµç¨‹æ”¹ä¸ºæ‰‹åŠ¨ä»GHCRæ‹‰å–ç¼“å­˜å±‚å¹¶ä½¿ç”¨docker composeéƒ¨ç½²ã€‚

**ç« èŠ‚æ¥æº**
- [verify-cache-layers.sh](file://scripts/verify-cache-layers.sh) - *å·²å½’æ¡£çš„ç¼“å­˜éªŒè¯è„šæœ¬*
- [remote-cache-prewarm-snapshot.md](file://documents/workflow-snapshots/remote-cache-prewarm-snapshot.md) - *å†å²å·¥ä½œæµå¿«ç…§*

## AIæœåŠ¡è°ƒç”¨ç®¡é“é‡æ„å½±å“

### é‡æ„æ¦‚è¿°

AIæœåŠ¡è°ƒç”¨ç®¡é“å·²é‡æ„ä¸ºç»Ÿä¸€çš„ç»“æ„åŒ–è°ƒç”¨ç®¡é“ï¼Œå–ä»£äº†æ—§çš„åŠ¨æ€ä»£ç†æ”¯æŒã€‚æ–°çš„ç®¡é“å¼•å…¥äº†æ™ºèƒ½é‡è¯•ã€è¦†ç›–ç‡è¯„ä¼°å’Œæ‰©å†™å›é€€ç­‰é«˜çº§åŠŸèƒ½ã€‚

**ä¸»è¦å˜æ›´ï¼š**
- **ç»Ÿä¸€è°ƒç”¨ç®¡é“**ï¼šæ‰€æœ‰AI APIè°ƒç”¨ï¼ˆå¦‚ç”Ÿæˆä¸»é¢˜ã€è½¬å½•ã€é—®é¢˜ã€è¯„åˆ†ã€æ‰©å†™ï¼‰å‡é€šè¿‡ `invokeStructured()` å‡½æ•°è¿›è¡Œï¼Œç¡®ä¿ä¸€è‡´çš„é”™è¯¯å¤„ç†å’Œç›‘æ§ã€‚
- **ç§»é™¤åŠ¨æ€ä»£ç†**ï¼šæ—§çš„ä»£ç†å¥åº·æ£€æŸ¥å’ŒåŠ¨æ€ä»£ç†é€‰æ‹©é€»è¾‘å·²è¢«ç§»é™¤ï¼Œç°åœ¨ç¡¬ç¼–ç ä½¿ç”¨ç”Ÿäº§ä»£ç†åœ°å€ã€‚
- **ç»“æ„åŒ–å“åº”**ï¼šåˆ©ç”¨JSON Schemaç¡®ä¿AIè¿”å›çš„æ•°æ®æ ¼å¼æ­£ç¡®ï¼Œé¿å…è§£æé”™è¯¯ã€‚
- **æ™ºèƒ½é‡è¯•ç­–ç•¥**ï¼šå¼•å…¥ `executeWithCoverageRetry` å‡½æ•°ï¼Œæ ¹æ®æ ‡ç­¾è¦†ç›–ç‡è¯„ä¼°ç»“æœå†³å®šæ˜¯å¦é‡è¯•ï¼Œç¡®ä¿ç”Ÿæˆå†…å®¹çš„å…¨é¢æ€§ã€‚
- **æ‰©å†™å›é€€è·¯å¾„**ï¼šå½“ç”Ÿæˆå†…å®¹é•¿åº¦ä¸è¶³æ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ‰©å†™å›é€€è·¯å¾„ï¼Œç¡®ä¿æ»¡è¶³å­—æ•°è¦æ±‚ã€‚
- **é¥æµ‹ä¸ç›‘æ§**ï¼šæ–°å¢ `telemetry.ts` æ¨¡å—ï¼Œè®°å½•æ¯æ¬¡AIè°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬é‡è¯•æ¬¡æ•°ã€å»¶è¿Ÿå’Œæœ€ç»ˆç»“æœã€‚

**ç« èŠ‚æ¥æº**
- [cerebras-service.ts](file://lib/ai/cerebras-service.ts) - *æ–°å¢ï¼Œç»Ÿä¸€çš„ç»“æ„åŒ–è°ƒç”¨ç®¡é“*
- [cerebras-client-manager.ts](file://lib/ai/cerebras-client-manager.ts) - *æ–°å¢ï¼ŒAIä»£ç†ç®¡ç†ä¸å¥åº·æ£€æŸ¥*
- [retry-strategy.ts](file://lib/ai/retry-strategy.ts) - *æ–°å¢ï¼Œç»“æ„åŒ–é‡è¯•ç­–ç•¥ä¸è¦†ç›–ç‡è¯„ä¼°*
- [project-board.md](file://documents/project-board.md) - *å·²ç§»é™¤åŠ¨æ€ä»£ç†æ”¯æŒ*
- [project-status.md](file://documents/project-status.md) - *å·²ç§»é™¤åŠ¨æ€ä»£ç†æ”¯æŒ*

### æ•…éšœæ’æŸ¥æ›´æ–°

ç”±äºAIæœåŠ¡è°ƒç”¨ç®¡é“çš„é‡æ„ï¼ŒAIæ¥å£è¶…æ—¶çš„æ’æŸ¥æµç¨‹éœ€è¦æ›´æ–°ï¼š

1. **æ£€æŸ¥APIå¯†é’¥å’ŒåŸºç¡€URL**
   ```bash
   # æ£€æŸ¥ç¯å¢ƒå˜é‡
   echo $CEREBRAS_API_KEY
   echo $CEREBRAS_BASE_URL
   ```

2. **éªŒè¯CerebrasæœåŠ¡å¥åº·çŠ¶æ€**
   ```bash
   # ä½¿ç”¨å†…ç½®å¥åº·æ£€æŸ¥
   curl -H "Authorization: Bearer $CEREBRAS_API_KEY" \
        https://api.cerebras.ai/v1/chat/completions \
        -d '{"messages": [{"role": "user", "content": "Respond exactly with {\"status\":\"ok\"}"}], "response_format": {"type": "json_schema", "json_schema": {"name": "cerebras_health_check", "strict": true, "schema": {"type": "object", "properties": {"status": {"type": "string"}}, "required": ["status"], "additionalProperties": false}}}}'
   ```

3. **æŸ¥çœ‹è¯¦ç»†çš„AIè°ƒç”¨æ—¥å¿—**
   ```bash
   # åœ¨æ—¥å¿—ä¸­æŸ¥æ‰¾AIè°ƒç”¨è¯¦æƒ…
   grep "Executing coverage retry" debug.log
   grep "AI call attempt" debug.log
   grep "Cerebras health check" debug.log
   ```

**ç« èŠ‚æ¥æº**
- [cerebras-client-manager.ts](file://lib/ai/cerebras-client-manager.ts#L15-L78) - *æ–°å¢ï¼Œä»£ç†çŠ¶æ€å¿«ç…§*
- [monitoring.ts](file://lib/monitoring.ts#L576-L626) - *æ–°å¢ï¼ŒCerebraså¥åº·æ£€æŸ¥å®ç°*
- [retry-strategy.ts](file://lib/ai/retry-strategy.ts#L50-L102) - *æ–°å¢ï¼Œè¦†ç›–ç‡é‡è¯•æ‰§è¡Œé€»è¾‘*

## éŸ³é¢‘æµå¤„ç†æœºåˆ¶

### Rangeè¯·æ±‚å¤„ç†

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant Server as "æœåŠ¡å™¨"
participant File as "éŸ³é¢‘æ–‡ä»¶"
Client->>Server : GET /tts_audio_1.wav
Server->>File : æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
alt æ–‡ä»¶å­˜åœ¨
File-->>Server : è¿”å›æ–‡ä»¶ä¿¡æ¯
Server->>Client : 200 OK + å®Œæ•´éŸ³é¢‘
else æ–‡ä»¶ä¸å­˜åœ¨
Server-->>Client : 404 Not Found
end
Client->>Server : GET /tts_audio_1.wav + Range : bytes=0-1023
Server->>File : æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
File-->>Server : è¿”å›æ–‡ä»¶ä¿¡æ¯
Server->>Server : è§£æRangeå¤´
alt Rangeæœ‰æ•ˆ
Server->>File : è¯»å–æŒ‡å®šå­—èŠ‚èŒƒå›´
File-->>Server : è¿”å›å­—èŠ‚æµ
Server->>Client : 206 Partial Content + æŒ‡å®šèŒƒå›´
else Rangeæ— æ•ˆ
Server->>Client : 416 Range Not Satisfiable
end
```

**å›¾ç¤ºæ¥æº**
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L19-L65) - *Rangeå¤´è§£æ*
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L67-L134) - *éƒ¨åˆ†å“åº”å¤„ç†*

### éŸ³é¢‘å…ƒæ•°æ®è§£æ

```mermaid
classDiagram
class AudioMetadata {
+duration : number
+sampleRate : number
+channels : number
+bitsPerSample : number
}
class AudioMetadataCache {
+[fileUrl : string] : AudioMetadata & { lastValidated : number, format : string }
}
class AudioUtils {
+getWavAudioMetadata(buffer : Buffer) : AudioMetadata
+detectAudioFormat(buffer : Buffer) : 'wav' | 'mp3' | 'unknown'
+getAudioMetadataFromUrl(url : string) : Promise<AudioMetadata | null>
+validateAudioFormat(buffer : Buffer) : { isValid : boolean; format : string; confidence : number }
}
AudioUtils --> AudioMetadata : "è¿”å›"
AudioUtils --> AudioMetadataCache : "è¯»å†™"
```

**å›¾ç¤ºæ¥æº**
- [audio-utils.ts](file://lib/audio-utils.ts#L22-L166) - *WAVå…ƒæ•°æ®è§£æ*
- [audio-utils.ts](file://lib/audio-utils.ts#L212-L254) - *URLå…ƒæ•°æ®è·å–*
- [audio-utils.ts](file://lib/audio-utils.ts#L256-L275) - *æ ¼å¼éªŒè¯*

### HTTP Rangeè¯·æ±‚å®ç°

`app/api/audio/[filename]/route.ts` æ–‡ä»¶å·²æ›´æ–°ä»¥æ”¯æŒHTTP Rangeè¯·æ±‚ï¼Œå®ç°éŸ³é¢‘æ–­ç‚¹ç»­æ’­åŠŸèƒ½ã€‚

**ä¸»è¦ç‰¹æ€§ï¼š**
- **Rangeå¤´è§£æ**ï¼šæ”¯æŒæ ‡å‡†çš„`bytes=start-end`æ ¼å¼ï¼ŒåŒ…æ‹¬åç¼€èŒƒå›´ï¼ˆ`bytes=-500`ï¼‰å’Œå¼€åŒºé—´èŒƒå›´ï¼ˆ`bytes=500-`ï¼‰ã€‚
- **éƒ¨åˆ†å“åº”**ï¼šå½“æ”¶åˆ°æœ‰æ•ˆçš„Rangeè¯·æ±‚æ—¶ï¼Œè¿”å›HTTP 206çŠ¶æ€ç å’Œ`Content-Range`å¤´ï¼Œä»…ä¼ è¾“è¯·æ±‚çš„å­—èŠ‚èŒƒå›´ã€‚
- **CORSæ”¯æŒ**ï¼šé€šè¿‡OPTIONSé¢„æ£€è¯·æ±‚æ”¯æŒè·¨åŸŸRangeè¯·æ±‚ï¼Œå…è®¸`Range`å’Œ`Content-Type`å¤´ã€‚
- **å®‰å…¨éªŒè¯**ï¼šåªå…è®¸è®¿é—®ä»¥`tts_audio_`å¼€å¤´ä¸”ä»¥`.wav`ç»“å°¾çš„æ–‡ä»¶ï¼Œé˜²æ­¢è·¯å¾„éå†æ”»å‡»ã€‚
- **é”™è¯¯å¤„ç†**ï¼šå¯¹æ— æ•ˆçš„Rangeè¯·æ±‚è¿”å›416çŠ¶æ€ç ï¼Œå¹¶æä¾›`Content-Range: bytes */fileSize`å¤´ã€‚

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```bash
# è·å–æ–‡ä»¶å‰1024å­—èŠ‚
curl -H "Range: bytes=0-1023" http://localhost:3000/tts_audio_1.wav -v

# è·å–æ–‡ä»¶æœ€å500å­—èŠ‚
curl -H "Range: bytes=-500" http://localhost:3000/tts_audio_1.wav -v

# è·å–ä»ç¬¬1000å­—èŠ‚åˆ°æ–‡ä»¶æœ«å°¾
curl -H "Range: bytes=1000-" http://localhost:3000/tts_audio_1.wav -v
```

**ç« èŠ‚æ¥æº**
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L19-L65) - *Rangeå¤´è§£æé€»è¾‘*
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L67-L134) - *éƒ¨åˆ†å“åº”å®ç°*
- [audio/[filename]/route.ts](file://app/api/audio/%5Bfilename%5D/route.ts#L137-L146) - *CORSé¢„æ£€æ”¯æŒ*

### éŸ³é¢‘å…ƒæ•°æ®å¤„ç†

`lib/audio-utils.ts` æ–‡ä»¶æä¾›äº†éŸ³é¢‘å…ƒæ•°æ®è§£æå’Œç¼“å­˜åŠŸèƒ½ï¼Œé¿å…å‰ç«¯ç­‰å¾…metadataäº‹ä»¶ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- **WAVå…ƒæ•°æ®è§£æ**ï¼šé€šè¿‡è§£æWAVæ–‡ä»¶å¤´ï¼Œç²¾ç¡®æå–æŒç»­æ—¶é—´ã€é‡‡æ ·ç‡ã€å£°é“æ•°å’Œä½æ·±åº¦ã€‚
- **æ ¼å¼æ£€æµ‹**ï¼šæ”¯æŒWAVå’ŒMP3æ ¼å¼æ£€æµ‹ï¼Œé€šè¿‡æ–‡ä»¶å¤´ç­¾åè¯†åˆ«ã€‚
- **å…ƒæ•°æ®ç¼“å­˜**ï¼šåœ¨å†…å­˜ä¸­ç¼“å­˜éŸ³é¢‘å…ƒæ•°æ®5åˆ†é’Ÿï¼Œå‡å°‘é‡å¤çš„ç½‘ç»œè¯·æ±‚å’Œæ–‡ä»¶è§£æã€‚
- **URLå…ƒæ•°æ®è·å–**ï¼šé€šè¿‡fetch APIè·å–è¿œç¨‹éŸ³é¢‘æ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œæ”¯æŒç¼“å­˜ã€‚
- **æ ¼å¼éªŒè¯**ï¼šéªŒè¯éŸ³é¢‘æ–‡ä»¶æ ¼å¼çš„æœ‰æ•ˆæ€§ï¼Œå¹¶æä¾›ç½®ä¿¡åº¦è¯„åˆ†ã€‚

**ä»£ç ç¤ºä¾‹ï¼š**
```typescript
// è·å–WAVç¼“å†²åŒºçš„å…ƒæ•°æ®
const metadata = getWavAudioMetadata(buffer);
console.log(`éŸ³é¢‘æ—¶é•¿: ${metadata.duration.toFixed(2)}ç§’`);

// ä»URLè·å–éŸ³é¢‘å…ƒæ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
const metadata = await getAudioMetadataFromUrl('/tts_audio_1.wav');
if (metadata) {
  console.log(`éŸ³é¢‘æ—¶é•¿: ${metadata.duration.toFixed(2)}ç§’`);
}

// éªŒè¯éŸ³é¢‘æ ¼å¼
const result = validateAudioFormat(buffer);
if (result.isValid) {
  console.log(`æ”¯æŒçš„æ ¼å¼: ${result.format}, ç½®ä¿¡åº¦: ${result.confidence}`);
}
```

**ç« èŠ‚æ¥æº**
- [audio-utils.ts](file://lib/audio-utils.ts#L22-L166) - *WAVå…ƒæ•°æ®è§£æå®ç°*
- [audio-utils.ts](file://lib/audio-utils.ts#L212-L254) - *URLå…ƒæ•°æ®è·å–å®ç°*
- [audio-utils.ts](file://lib/audio-utils.ts#L256-L275) - *æ ¼å¼éªŒè¯å®ç°*