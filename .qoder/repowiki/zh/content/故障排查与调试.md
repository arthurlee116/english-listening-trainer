# æ•…éšœæ’æŸ¥ä¸è°ƒè¯•

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [WRONG-ANSWERS-AI-TROUBLESHOOTING.md](file://documents/WRONG-ANSWERS-AI-TROUBLESHOOTING.md)
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts)
- [metrics/route.ts](file://app/api/performance/metrics/route.ts)
- [kokoro-service-enhanced.ts](file://lib/kokoro-service-enhanced.ts)
- [tts-service.ts](file://lib/tts-service.ts)
- [i18n/performance.ts](file://lib/i18n/performance.ts)
- [bilingual-example.tsx](file://components/examples/bilingual-example.tsx)
- [CACHE_TROUBLESHOOTING.md](file://CACHE_TROUBLESHOOTING.md)
- [SPACY_MODEL_FIX.md](file://documents/SPACY_MODEL_FIX.md)
- [Dockerfile](file://Dockerfile)
</cite>

## æ›´æ–°æ‘˜è¦
- æ–°å¢ **Dockeræ„å»ºç¼“å­˜é—®é¢˜æ’æŸ¥** ç« èŠ‚ï¼Œæ¶µç›–å¤šå±‚çº§ç¼“å­˜æ¶æ„ã€ç¼“å­˜å¤±æ•ˆå’Œæ€§èƒ½ç›‘æ§
- æ–°å¢ **SpaCyæ¨¡å‹ç¦»çº¿å®‰è£…é—®é¢˜** è§£å†³æ–¹æ¡ˆï¼Œè§£å†³TTSå¼•æ“å› ç½‘ç»œé™åˆ¶å¯¼è‡´çš„åˆå§‹åŒ–å¤±è´¥
- æ›´æ–° **TTSå¼•æ“æ•…éšœæ’æŸ¥** éƒ¨åˆ†ï¼Œå¢åŠ SpaCyæ¨¡å‹é¢„å®‰è£…çš„è§£å†³æ–¹æ¡ˆ
- æ‰©å±• **æ€§èƒ½ç›‘æ§æŒ‡æ ‡** éƒ¨åˆ†ï¼Œå¢åŠ æ„å»ºç¼“å­˜æ€§èƒ½æŒ‡æ ‡
- æ›´æ–°æ–‡æ¡£å¼•ç”¨æ–‡ä»¶åˆ—è¡¨ï¼ŒåŒ…å«æ–°å¼•å…¥çš„ç¼“å­˜å’Œæ¨¡å‹ä¿®å¤æ–‡æ¡£

## ç›®å½•
1. [å¸¸è§é—®é¢˜è¯Šæ–­](#å¸¸è§é—®é¢˜è¯Šæ–­)
2. [TTSå¼•æ“æ•…éšœæ’æŸ¥](#ttså¼•æ“æ•…éšœæ’æŸ¥)
3. [AIæ¥å£è¶…æ—¶å¤„ç†](#aiæ¥å£è¶…æ—¶å¤„ç†)
4. [éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ](#éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ)
5. [åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±è§£å†³](#åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±è§£å†³)
6. [è¿œç¨‹è°ƒè¯•å·¥å…·ä½¿ç”¨](#è¿œç¨‹è°ƒè¯•å·¥å…·ä½¿ç”¨)
7. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)
8. [æ€§èƒ½ç›‘æ§æŒ‡æ ‡](#æ€§èƒ½ç›‘æ§æŒ‡æ ‡)
9. [æ—¥å¿—åˆ†ææŠ€å·§](#æ—¥å¿—åˆ†ææŠ€å·§)
10. [Dockeræ„å»ºç¼“å­˜é—®é¢˜æ’æŸ¥](#dockeræ„å»ºç¼“å­˜é—®é¢˜æ’æŸ¥)
11. [SpaCyæ¨¡å‹ç¦»çº¿å®‰è£…é—®é¢˜](#spacyæ¨¡å‹ç¦»çº¿å®‰è£…é—®é¢˜)

## å¸¸è§é—®é¢˜è¯Šæ–­

### TTSå¼•æ“å¯åŠ¨å¤±è´¥

#### ç—‡çŠ¶ï¼šTTSæœåŠ¡æ— æ³•å¯åŠ¨æˆ–åˆå§‹åŒ–å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- Pythonç¯å¢ƒé…ç½®é—®é¢˜
- GPUé©±åŠ¨æˆ–CUDAæœªæ­£ç¡®å®‰è£…
- æ¨¡å‹æ–‡ä»¶ç¼ºå¤±æˆ–æŸå
- ç³»ç»Ÿèµ„æºä¸è¶³ï¼ˆå†…å­˜ã€æ˜¾å­˜ï¼‰
- ä¾èµ–åº“ç‰ˆæœ¬å†²çª
- SpaCyæ¨¡å‹è¿è¡Œæ—¶ä¸‹è½½å¤±è´¥ï¼ˆç½‘ç»œé™åˆ¶ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥Pythonç¯å¢ƒ**
   ```bash
   # éªŒè¯Pythonç‰ˆæœ¬
   python --version
   
   # æ£€æŸ¥å…³é”®æ¨¡å—
   python -c "import torch, phonemizer, espeakng_loader"
   ```

2. **éªŒè¯GPUæ”¯æŒ**
   ```bash
   # æ£€æŸ¥CUDAå¯ç”¨æ€§
   python -c "import torch; print(torch.cuda.is_available())"
   
   # æŸ¥çœ‹GPUè®¾å¤‡ä¿¡æ¯
   nvidia-smi
   ```

3. **æ£€æŸ¥æ¨¡å‹æ–‡ä»¶**
   ```bash
   # éªŒè¯TTSæ¨¡å‹ç›®å½•
   ls -la kokoro-main-ref/models/
   
   # æ£€æŸ¥espeak-ngæ•°æ®è·¯å¾„
   python -c "from espeakng_loader import get_data_path; print(get_data_path())"
   ```

4. **æŸ¥çœ‹ç³»ç»Ÿèµ„æº**
   ```bash
   # æ£€æŸ¥å†…å­˜ä½¿ç”¨
   free -h
   
   # æ£€æŸ¥ç£ç›˜ç©ºé—´
   df -h
   ```

**Section sources**
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)
- [kokoro-service-enhanced.ts](file://lib/kokoro-service-enhanced.ts#L83-L121)

### AIæ¥å£è¶…æ—¶

#### ç—‡çŠ¶ï¼šAIåˆ†æè¯·æ±‚è¶…æ—¶æˆ–å“åº”ç¼“æ…¢

**å¯èƒ½åŸå› ï¼š**
- Cerebras APIæœåŠ¡ä¸å¯ç”¨
- ç½‘ç»œè¿æ¥é—®é¢˜
- ä»£ç†é…ç½®é”™è¯¯
- è¯·æ±‚é¢‘ç‡è¶…è¿‡é™åˆ¶
- è¾“å…¥æ–‡æœ¬è¿‡é•¿

**è§£å†³æ–¹æ¡ˆï¼š**

1. **éªŒè¯APIè¿æ¥**
   ```bash
   # æµ‹è¯•APIå¯†é’¥æœ‰æ•ˆæ€§
   curl -H "Authorization: Bearer $CEREBRAS_API_KEY" \
        https://api.cerebras.ai/v1/models
   
   # æµ‹è¯•ç½‘ç»œè¿é€šæ€§
   curl -I https://api.cerebras.ai
   ```

2. **è°ƒæ•´å¹¶å‘è®¾ç½®**
   ```typescript
   // å‡å°‘å¹¶å‘è¯·æ±‚æ•°
   const limit = pLimit(5); // é»˜è®¤ä¸º10
   
   // æ‰¹é‡å¤„ç†åˆ†å—
   const chunkSize = 20;
   ```

3. **å®ç°é‡è¯•æœºåˆ¶**
   ```typescript
   // ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
   const retryDelay = Math.min(1000 * Math.pow(2, attempt), 10000);
   ```

**Section sources**
- [WRONG-ANSWERS-AI-TROUBLESHOOTING.md](file://documents/WRONG-ANSWERS-AI-TROUBLESHOOTING.md)
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L298-L337)

### éŸ³é¢‘æ’­æ”¾å¼‚å¸¸

#### ç—‡çŠ¶ï¼šéŸ³é¢‘æ— æ³•æ’­æ”¾æˆ–æ’­æ”¾ä¸­æ–­

**å¯èƒ½åŸå› ï¼š**
- éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆå¤±è´¥
- æ–‡ä»¶æ ¼å¼ä¸å…¼å®¹
- ç½‘ç»œä¼ è¾“é—®é¢˜
- æµè§ˆå™¨ç¼“å­˜é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶**
   ```bash
   # éªŒè¯éŸ³é¢‘ç›®å½•
   ls -la public/audio/
   
   # æ£€æŸ¥æ–‡ä»¶æƒé™
   chmod -R 755 public/audio/
   ```

2. **éªŒè¯æ–‡ä»¶æ ¼å¼**
   ```typescript
   // æ”¯æŒçš„æ ¼å¼åŒ…æ‹¬WAVå’ŒMP3
   export function validateAudioFormat(buffer: Buffer) {
     const format = detectAudioFormat(buffer);
     return { isValid: ['wav', 'mp3'].includes(format), format };
   }
   ```

3. **æ¸…ç†æ—§æ–‡ä»¶**
   ```bash
   # åˆ é™¤7å¤©å‰çš„éŸ³é¢‘æ–‡ä»¶
   find public/ -name "*.wav" -mtime +7 -delete
   ```

**Section sources**
- [tts-service.ts](file://lib/tts-service.ts#L49-L66)
- [audio-utils.ts](file://lib/audio-utils.ts#L239-L264)

### åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±

#### ç—‡çŠ¶ï¼šä¸­è‹±æ–‡æ–‡æœ¬æ˜¾ç¤ºé¡ºåºæ··ä¹±æˆ–å†…å®¹ç¼ºå¤±

**å¯èƒ½åŸå› ï¼š**
- å›½é™…åŒ–é…ç½®é”™è¯¯
- ç¼“å­˜å¤±æ•ˆ
- ç»„ä»¶æ¸²æŸ“é—®é¢˜
- æ•°æ®æ ¼å¼ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ£€æŸ¥å›½é™…åŒ–é…ç½®**
   ```typescript
   // éªŒè¯ç¿»è¯‘èµ„æº
   import translations from '@/lib/i18n/translations/components.json';
   
   // æ£€æŸ¥åŒè¯­ç»„ä»¶ä½¿ç”¨
   <BilingualText translationKey="common:buttons.generate" />
   ```

2. **æ¸…é™¤ç¼“å­˜**
   ```bash
   # æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   # å¼€å‘è€…å·¥å…· -> Application -> Clear site data
   ```

3. **éªŒè¯æ•°æ®ç»“æ„**
   ```json
   {
     "en": "Generate",
     "zh": "ç”Ÿæˆ"
   }
   ```

**Section sources**
- [bilingual-example.tsx](file://components/examples/bilingual-example.tsx)
- [i18n/types.ts](file://lib/i18n/types.ts#L46-L106)

## TTSå¼•æ“æ•…éšœæ’æŸ¥

### å¯åŠ¨æµç¨‹åˆ†æ

```mermaid
flowchart TD
Start([å¯åŠ¨TTSæœåŠ¡]) --> CheckEnv["æ£€æŸ¥Pythonç¯å¢ƒ"]
CheckEnv --> EnvValid{"ç¯å¢ƒæ­£å¸¸?"}
EnvValid --> |å¦| FixEnv["ä¿®å¤ç¯å¢ƒé…ç½®"]
EnvValid --> |æ˜¯| LoadModels["åŠ è½½TTSæ¨¡å‹"]
LoadModels --> ModelsLoaded{"æ¨¡å‹åŠ è½½æˆåŠŸ?"}
ModelsLoaded --> |å¦| CheckModelPath["æ£€æŸ¥æ¨¡å‹è·¯å¾„"]
ModelsLoaded --> |æ˜¯| InitService["åˆå§‹åŒ–æœåŠ¡"]
InitService --> ServiceReady{"æœåŠ¡å°±ç»ª?"}
ServiceReady --> |å¦| RestartService["é‡å¯æœåŠ¡"]
ServiceReady --> |æ˜¯| End([æœåŠ¡å¯åŠ¨æˆåŠŸ])
FixEnv --> CheckEnv
CheckModelPath --> LoadModels
RestartService --> InitService
```

**Diagram sources**
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)
- [kokoro-service-enhanced.ts](file://lib/kokoro-service-enhanced.ts#L83-L121)

### é”™è¯¯æ¢å¤æœºåˆ¶

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Initializing : "å¼€å§‹åˆå§‹åŒ–"
Initializing --> Ready : "åˆå§‹åŒ–æˆåŠŸ"
Initializing --> Error : "åˆå§‹åŒ–å¤±è´¥"
Ready --> Processing : "æ¥æ”¶è¯·æ±‚"
Processing --> Ready : "å¤„ç†å®Œæˆ"
Processing --> Error : "å¤„ç†å¤±è´¥"
Error --> Recovering : "å°è¯•æ¢å¤"
Recovering --> Initializing : "é‡æ–°åˆå§‹åŒ–"
Recovering --> Shutdown : "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
Shutdown --> [*]
```

**Diagram sources**
- [enhanced-tts-service.ts](file://lib/enhanced-tts-service.ts#L424-L467)
- [kokoro-service-gpu.ts](file://lib/kokoro-service-gpu.ts#L280-L318)

## AIæ¥å£è¶…æ—¶å¤„ç†

### è¶…æ—¶é‡è¯•ç­–ç•¥

```mermaid
flowchart LR
Request --> RetryCount["é‡è¯•è®¡æ•°=0"]
RetryCount --> MaxAttempts{"è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°?"}
MaxAttempts --> |å¦| Wait["ç­‰å¾…å»¶è¿Ÿæ—¶é—´"]
Wait --> CallAPI["è°ƒç”¨AIæ¥å£"]
CallAPI --> Success{"è°ƒç”¨æˆåŠŸ?"}
Success --> |æ˜¯| ReturnResult["è¿”å›ç»“æœ"]
Success --> |å¦| IncreaseRetry["é‡è¯•è®¡æ•°++"]
IncreaseRetry --> Backoff["è®¡ç®—é€€é¿æ—¶é—´"]
Backoff --> Wait
MaxAttempts --> |æ˜¯| ReturnError["è¿”å›é”™è¯¯"]
style Wait fill:#f9f,stroke:#333
style CallAPI fill:#bbf,stroke:#333
```

**Diagram sources**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L270-L393)
- [rate-limiter.ts](file://lib/rate-limiter.ts#L215-L276)

## éŸ³é¢‘æ’­æ”¾å¼‚å¸¸åˆ†æ

### éŸ³é¢‘ç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
participant UI as "ç”¨æˆ·ç•Œé¢"
participant Player as "éŸ³é¢‘æ’­æ”¾å™¨"
participant Service as "TTSæœåŠ¡"
participant Storage as "å­˜å‚¨ç³»ç»Ÿ"
UI->>Player : è¯·æ±‚æ’­æ”¾éŸ³é¢‘
Player->>Storage : æ£€æŸ¥æœ¬åœ°ç¼“å­˜
alt ç¼“å­˜å­˜åœ¨
Storage-->>Player : è¿”å›éŸ³é¢‘æ–‡ä»¶
else ç¼“å­˜ä¸å­˜åœ¨
Player->>Service : è¯·æ±‚ç”ŸæˆéŸ³é¢‘
Service->>Service : å¤„ç†æ–‡æœ¬è½¬è¯­éŸ³
Service-->>Player : è¿”å›éŸ³é¢‘URL
Player->>Storage : ç¼“å­˜éŸ³é¢‘æ–‡ä»¶
end
Player->>UI : å¼€å§‹æ’­æ”¾
loop æ’­æ”¾è¿‡ç¨‹
Player->>UI : æ›´æ–°æ’­æ”¾è¿›åº¦
end
Player->>UI : æ’­æ”¾å®Œæˆ
```

**Diagram sources**
- [tts-service.ts](file://lib/tts-service.ts#L68-L98)
- [optimized-audio-player.tsx](file://components/optimized-audio-player.tsx#L299-L325)

## åŒè¯­æ–‡æœ¬æ˜¾ç¤ºé”™ä¹±è§£å†³

### å›½é™…åŒ–æ€§èƒ½ç›‘æ§

```mermaid
classDiagram
class I18nPerformanceMonitor {
-metrics : PerformanceMetrics
-translationTimes : number[]
-startTime : number
+startTranslation()
+endTranslation()
+recordCacheHit(type)
+recordCacheMiss(type)
+updateMemoryUsage(size)
+setTranslationLoadTime(time)
+getMetrics()
+getCacheHitRatios()
+reset()
+logPerformanceSummary()
}
class PerformanceMetrics {
+translationCacheHits : number
+translationCacheMisses : number
+formatCacheHits : number
+formatCacheMisses : number
+translationLoadTime : number
+averageTranslationTime : number
+memoryUsage : object
}
I18nPerformanceMonitor --> PerformanceMetrics : "åŒ…å«"
```

**Diagram sources**
- [i18n/performance.ts](file://lib/i18n/performance.ts#L17-L136)
- [enablePerformanceLogging](file://lib/i18n/performance.ts#L142-L149)

## è¿œç¨‹è°ƒè¯•å·¥å…·ä½¿ç”¨

### debug-kokoro-remote.pyä½¿ç”¨æŒ‡å—

è¯¥è„šæœ¬ç”¨äºæ’æŸ¥misaki/espeakå…¼å®¹æ€§é—®é¢˜ï¼Œæä¾›å…¨é¢çš„ç¯å¢ƒæ£€æŸ¥åŠŸèƒ½ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**
- Pythonç‰ˆæœ¬æ£€æŸ¥
- å…³é”®æ¨¡å—å¯¼å…¥æµ‹è¯•
- EspeakWrapperæ–¹æ³•éªŒè¯
- misaki.espeakç‰¹å®šé…ç½®æµ‹è¯•
- Kokoroå¯¼å…¥å’Œå®ä¾‹åŒ–æµ‹è¯•
- CUDAå¯ç”¨æ€§æ£€æµ‹

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
python scripts/debug-kokoro-remote.py
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
=== Kokoro TTS è¿œç¨‹è°ƒè¯• ===
Pythonç‰ˆæœ¬: 3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0]
âœ“ torch - å¯¼å…¥æˆåŠŸ
âœ“ phonemizer - å¯¼å…¥æˆåŠŸ
âœ“ espeakng_loader - å¯¼å…¥æˆåŠŸ
âœ“ misaki - å¯¼å…¥æˆåŠŸ
âœ“ misaki.espeak - å¯¼å…¥æˆåŠŸ
âœ“ EspeakWrapperå¯ç”¨æ–¹æ³•: [set_library, set_data_path, __init__, ...]
âœ“ æœ‰set_data_pathæ–¹æ³•: True
âœ“ espeakngåº“è·¯å¾„: /usr/lib/x86_64-linux-gnu/libespeak-ng.so.1
âœ“ espeakngæ•°æ®è·¯å¾„: /usr/share/espeak-ng-data
âœ“ EspeakWrapperé…ç½®æˆåŠŸ
=== æµ‹è¯•Kokoroå¯¼å…¥ ===
âœ“ KPipelineå¯¼å…¥æˆåŠŸ
âœ“ KPipelineåˆ›å»ºæˆåŠŸ
=== æµ‹è¯•CUDA ===
âœ“ CUDAå¯ç”¨: True
âœ“ CUDAè®¾å¤‡æ•°é‡: 1
âœ“ å½“å‰CUDAè®¾å¤‡: 0
âœ“ è®¾å¤‡åç§°: NVIDIA GeForce RTX 3090
```

**Section sources**
- [debug-kokoro-remote.py](file://scripts/debug-kokoro-remote.py)

## é”™è¯¯å¤„ç†æœºåˆ¶

### å¢å¼ºå‹é”™è¯¯å¤„ç†å™¨

```mermaid
classDiagram
class AppError {
+message : string
+context : ErrorContext
+originalError? : Error
+toResponse() : NextResponse
+getStatusCode() : number
+getUserMessage() : string
}
class ErrorContext {
+type : ErrorType
+severity : ErrorSeverity
+component? : string
+userId? : string
+operation? : string
+metadata? : Record<string, unknown>
}
class ErrorMonitor {
-errorCounts : Map<string, number>
-lastErrors : Map<string, Date>
-circuitBreakers : Map<string, CircuitBreakerState>
+recordError(context, error)
+isCircuitBreakerOpen(key)
+recordSuccess(key)
+getErrorStats()
}
class OperationCanceller {
-controllers : Map<string, AbortController>
+createOperation(id)
+cancelOperation(id)
+cancelAllOperations()
+isOperationCancelled(id)
}
AppError --> ErrorContext
ErrorMonitor --> AppError : "è®°å½•"
OperationCanceller --> AppError : "å–æ¶ˆ"
```

**Diagram sources**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L270-L393)
- [ErrorMonitor](file://lib/enhanced-error-handler.ts#L147-L270)

### é”™è¯¯ç±»å‹åˆ†ç±»

| é”™è¯¯ç±»å‹ | HTTPçŠ¶æ€ç  | ç”¨æˆ·æç¤º | ä¸¥é‡ç¨‹åº¦ |
|---------|----------|--------|--------|
| VALIDATION | 400 | è¾“å…¥æ•°æ®æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯• | ä½ |
| DATABASE | 500 | æ•°æ®è®¿é—®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯• | é«˜ |
| TTS_SERVICE | 503 | è¯­éŸ³æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• | é«˜ |
| AI_SERVICE | 503 | AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• | é«˜ |
| NETWORK | 500 | ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯• | ä¸­ |
| RATE_LIMIT | 429 | æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯• | ä¸­ |
| RESOURCE | 500 | ç³»ç»Ÿèµ„æºä¸è¶³ï¼Œè¯·ç¨åé‡è¯• | é«˜ |

**Section sources**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L298-L337)

## æ€§èƒ½ç›‘æ§æŒ‡æ ‡

### performance/metrics API

è¯¥APIæä¾›ç³»ç»Ÿæ€§èƒ½ç›‘æ§æ•°æ®ï¼Œå¯ç”¨äºå®æ—¶ç›‘æ§ç³»ç»Ÿè´Ÿè½½ã€‚

**ç«¯ç‚¹ï¼š** `/api/performance/metrics`

**è¿”å›æ•°æ®ç»“æ„ï¼š**
```json
{
  "success": true,
  "detailed": {
    "performanceHistory": [
      {
        "latest": 95,
        "trend": "improving",
        "reliability": "high"
      }
    ],
    "resourceUtilization": {
      "cpu": 45.2,
      "memory": 67.8,
      "disk": 32.1
    },
    "errorRates": {
      "tts": 0.02,
      "ai": 0.05,
      "database": 0.01
    }
  }
}
```

**å…³é”®æŒ‡æ ‡ï¼š**
- `api_request_duration`: APIè¯·æ±‚æŒç»­æ—¶é—´
- `memory_rss`: å†…å­˜å¸¸é©»é›†å¤§å°
- `memory_heap_used`: å †å†…å­˜ä½¿ç”¨é‡
- `database_operation_duration`: æ•°æ®åº“æ“ä½œæŒç»­æ—¶é—´
- `build_cache_hit_rate`: æ„å»ºç¼“å­˜å‘½ä¸­ç‡
- `build_cache_restore_time`: æ„å»ºç¼“å­˜æ¢å¤æ—¶é—´

```mermaid
graph TB
subgraph "ç›‘æ§æŒ‡æ ‡"
A[APIè¯·æ±‚æ—¶é•¿]
B[å†…å­˜ä½¿ç”¨]
C[æ•°æ®åº“æ€§èƒ½]
D[é”™è¯¯ç‡]
E[æ„å»ºç¼“å­˜æ€§èƒ½]
end
subgraph "æ•°æ®é‡‡é›†"
F[recordMetric]
G[startRequest]
H[endRequest]
I[recordMemoryUsage]
J[recordDatabaseMetric]
K[recordBuildCacheMetric]
end
subgraph "æ•°æ®åˆ†æ"
L[getMetricStats]
M[getRecentMetrics]
N[getActiveRequestCount]
O[getBuildCacheStats]
end
F --> A
G --> A
H --> A
I --> B
J --> C
K --> E
L --> D
M --> D
N --> A
O --> E
```

**Diagram sources**
- [metrics/route.ts](file://app/api/performance/metrics/route.ts#L75-L82)
- [monitoring.ts](file://lib/monitoring.ts#L270-L393)
- [CACHE_TROUBLESHOOTING.md](file://CACHE_TROUBLESHOOTING.md)

## æ—¥å¿—åˆ†ææŠ€å·§

### å…³é”®æ—¥å¿—æ¨¡å¼

**TTSæœåŠ¡ç›¸å…³æ—¥å¿—ï¼š**
- `ğŸš€ Initializing Kokoro TTS service...` - æœåŠ¡å¼€å§‹åˆå§‹åŒ–
- `âœ… Kokoro TTS service initialized successfully` - æœåŠ¡åˆå§‹åŒ–æˆåŠŸ
- `ğŸ”¥ TTS service process error:` - TTSè¿›ç¨‹é”™è¯¯
- `ğŸ”„ Restarting TTS service` - æœåŠ¡é‡å¯å°è¯•
- `âŒ Max restart attempts reached` - è¾¾åˆ°æœ€å¤§é‡å¯æ¬¡æ•°

**AIæœåŠ¡ç›¸å…³æ—¥å¿—ï¼š**
- `Network connectivity issues with Cerebras API` - ç½‘ç»œè¿æ¥é—®é¢˜
- `Rate limiting exceeded for AI service` - è¶…å‡ºé€Ÿç‡é™åˆ¶
- `AI analysis generation failed` - AIåˆ†æç”Ÿæˆå¤±è´¥

**æ•°æ®åº“ç›¸å…³æ—¥å¿—ï¼š**
- `SQLITE_BUSY database is locked` - æ•°æ®åº“é”å®š
- `Database migration applied successfully` - æ•°æ®åº“è¿ç§»æˆåŠŸ
- `Slow query detected: SELECT * FROM ...` - æ£€æµ‹åˆ°æ…¢æŸ¥è¯¢

### æ—¥å¿—çº§åˆ«è¯´æ˜

| æ—¥å¿—çº§åˆ« | é¢œè‰²æ ‡è¯† | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|
| ğŸš¨ CRITICAL | çº¢è‰² | ç³»ç»Ÿå´©æºƒã€æœåŠ¡ä¸å¯ç”¨ |
| ğŸ”´ HIGH | çº¢è‰² | ä¸¥é‡é”™è¯¯ã€æ•°æ®ä¸¢å¤±é£é™© |
| ğŸŸ¡ MEDIUM | é»„è‰² | å¯æ¢å¤é”™è¯¯ã€è­¦å‘Š |
| ğŸ”µ LOW | è“è‰² | ä¿¡æ¯æ€§æ¶ˆæ¯ã€è°ƒè¯•ä¿¡æ¯ |

**Section sources**
- [enhanced-error-handler.ts](file://lib/enhanced-error-handler.ts#L200-L260)
- [WRONG-ANSWERS-AI-TROUBLESHOOTING.md](file://documents/WRONG-ANSWERS-AI-TROUBLESHOOTING.md)

## Dockeræ„å»ºç¼“å­˜é—®é¢˜æ’æŸ¥

### 2024å¹´ç¼“å­˜æ¶æ„å·®å¼‚

#### æ–°çš„å¤šå±‚çº§ç³»ç»Ÿ
1. **æœ¬åœ°ç¼“å­˜ (`type=local`)**: ä¸»è¦ç¼“å­˜ï¼Œä½äº `/tmp/.buildx-cache`ï¼Œé€Ÿåº¦æœ€å¿«
2. **GHAç¼“å­˜ (`type=gha`)**: GitHub ActionsåŸç”Ÿç¼“å­˜ï¼Œä½œä¸ºäºŒçº§ç¼“å­˜
3. **æ³¨å†Œè¡¨ç¼“å­˜ (`type=registry`)**: æŒä¹…åŒ–å¤‡ä»½ç¼“å­˜

#### å…³é”®ä¾èµ–
- **ç¼“å­˜ç§»åŠ¨æ­¥éª¤**: ç¡®ä¿æ­£ç¡®å¤„ç†ç¼“å­˜ç›®å½•
- **BuildKité…ç½®**: å¢å¼ºäº†å¹¶è¡Œæ€§å’Œç½‘ç»œä¼˜åŒ–
- **åŠ¨ä½œç¯å¢ƒå˜é‡**: ç¦ç”¨æ„å»ºæ‘˜è¦ä»¥æé«˜æ€§èƒ½

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### 1. ç¼“å­˜æœªæ¢å¤ï¼ˆæ„å»ºè€—æ—¶20åˆ†é’Ÿä»¥ä¸Šï¼‰

**ç—‡çŠ¶ï¼š**
- æ„å»ºæ¯æ¬¡éƒ½ä»å¤´å¼€å§‹
- æ„å»ºè¾“å‡ºä¸­æ²¡æœ‰"CACHED"æ¶ˆæ¯
- æ‰€æœ‰Dockerå±‚éƒ½è¢«é‡æ–°æ„å»ºè€Œä¸æ˜¯å¤ç”¨

**è¯Šæ–­æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥ç¼“å­˜ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la /tmp/.buildx-cache

# éªŒè¯ç¼“å­˜é”®æ˜¯å¦åŒ¹é…é¢„æœŸæ¨¡å¼
echo "é¢„æœŸé”®: ubuntu-latest-buildx-$(git rev-parse HEAD)"

# æ£€æŸ¥GitHub Actionsç¼“å­˜çŠ¶æ€
# åœ¨å·¥ä½œæµæ—¥å¿—ä¸­æŸ¥æ‰¾:
# "Cache restored from key: ubuntu-latest-buildx-"
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **éªŒè¯ç¼“å­˜é”®ç”Ÿæˆï¼š**
   ```yaml
   # æ£€æŸ¥ç¼“å­˜é”®æ­¥éª¤æ˜¯å¦ç”Ÿæˆæ­£ç¡®çš„é”®
   - name: è°ƒè¯•ç¼“å­˜é”®
     run: |
       echo "æ“ä½œç³»ç»Ÿ: ${{ runner.os }}"
       echo "SHA: ${{ github.sha }}"
       echo "ç¼“å­˜é”®åº”ä¸º: ${{ runner.os }}-buildx-${{ github.sha }}"
   ```

2. **æ£€æŸ¥ç¼“å­˜ç§»åŠ¨æ­¥éª¤ï¼š**
   åœ¨å·¥ä½œæµæ—¥å¿—ä¸­æŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š
   ```
   æ­£åœ¨ç§»åŠ¨Dockerç¼“å­˜ä»¥æ­£ç¡®å¤„ç†ç›®å½•...
   ç¼“å­˜ç§»åŠ¨æˆåŠŸå®Œæˆ
   ```

3. **éªŒè¯BuildKitè®¾ç½®ï¼š**
   å¢å¼ºçš„BuildKité…ç½®åº”æ˜¾ç¤ºä»¥ä¸‹åŠŸèƒ½ï¼š
   ```
   Buildx: Docker Buildx + BuildKit
   æœ€å¤§å¹¶è¡Œåº¦: 4
   ç½‘ç»œ: host
   ```

#### 2. ç¼“å­˜æŸåé—®é¢˜

**ç—‡çŠ¶ï¼š**
- æ„å»ºåœ¨ç¼“å­˜æ¢å¤æœŸé—´å¤±è´¥
- "failed to solve: failed to read cache" é”™è¯¯
- æ„å»ºè¡Œä¸ºä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆï¼š**

1. **å¿«é€Ÿä¿®å¤ - æ‰‹åŠ¨é‡å»ºï¼š**
   ä½¿ç”¨ `rebuild-cache=true` å‚æ•°è§¦å‘å·¥ä½œæµ

2. **æ‰‹åŠ¨æ¸…é™¤æ³¨å†Œè¡¨ç¼“å­˜ï¼š**
   ```bash
   # åˆ é™¤æ‰€æœ‰ç¼“å­˜æ ‡ç­¾ï¼ˆéœ€è¦GHCRè®¿é—®æƒé™ï¼‰
   docker rmi ghcr.io/arthurlee116/english-listening-trainer:cache-base
   docker rmi ghcr.io/arthurlee116/english-listening-trainer:cache-python-deps
   docker rmi ghcr.io/arthurlee116/english-listening-trainer:cache-node-deps
   docker rmi ghcr.io/arthurlee116/english-listening-trainer:cache-builder
   ```

3. **æ¸…é™¤GitHub Actionsç¼“å­˜ï¼š**
   - è¿›å…¥ä»“åº“è®¾ç½® â†’ Actions â†’ Caches
   - åˆ é™¤æ‰€æœ‰"english-listening-trainer"èŒƒå›´çš„ç¼“å­˜

#### 3. ç¼“å­˜æ€§èƒ½ç¼“æ…¢

**ç—‡çŠ¶ï¼š**
- ç¼“å­˜æ¢å¤è€—æ—¶è¶…è¿‡2åˆ†é’Ÿ
- å°½ç®¡æœ‰ç¼“å­˜å‘½ä¸­ï¼Œæ„å»ºé€Ÿåº¦ä»æ¯”é¢„æœŸæ…¢

**è¯Šæ–­æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥ç¼“å­˜å¤§å°
docker buildx du --verbose

# æ£€æŸ¥ç¼“å­˜ä¼ è¾“
docker buildx build --progress=plain --target=base .
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **ä¼˜åŒ–æ„å»ºä¸Šä¸‹æ–‡ï¼š**
   - ç¡®ä¿æ­£ç¡®é…ç½®äº†`.dockerignore`
   - ä»æ„å»ºä¸Šä¸‹æ–‡ä¸­æ’é™¤ä¸å¿…è¦çš„å¤§æ–‡ä»¶

2. **æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š**
   - éªŒè¯ä¸GHCRçš„ç¨³å®šè¿æ¥
   - è€ƒè™‘åŒºåŸŸç½‘ç»œé—®é¢˜

3. **ç›‘æ§ç¼“å­˜å‹ç¼©ï¼š**
   - å·¥ä½œæµä½¿ç”¨`compression=zstd`è¿›è¡Œæœ€ä½³ä¼ è¾“
   - è€ƒè™‘ä½¿ç”¨`compression=estargz`ä»¥å®ç°æ›´å¿«çš„æ‹‰å–

#### 4. ç¼“å­˜å¤±æ•ˆæœªç”Ÿæ•ˆ

**ç—‡çŠ¶ï¼š**
- æ›´æ–°åä»ä½¿ç”¨æ—§ä¾èµ–
- package.jsonæ›´æ”¹åæœªå®‰è£…æ–°åŒ…

**è§£å†³æ–¹æ¡ˆï¼š**

1. **éªŒè¯æ–‡ä»¶å“ˆå¸Œï¼š**
   æ£€æŸ¥ä¾èµ–æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¡®è·Ÿè¸ªï¼š
   ```bash
   # åœ¨å·¥ä½œæµä¸­ï¼Œæ£€æŸ¥ç”Ÿæˆçš„ç¼“å­˜é”®
   echo "ç¼“å­˜é”®:"
   echo "åŸºç¡€: $(git hash-object Dockerfile)"
   echo "Python: $(cat kokoro-local/requirements.txt | git hash-object --stdin)"
   echo "Node: $(cat package.json package-lock.json | git hash-object --stdin)"
   ```

2. **å¼ºåˆ¶é˜¶æ®µé‡å»ºï¼š**
   - åœ¨ç›¸å…³Dockerfileé˜¶æ®µæ·»åŠ æ³¨é‡Š
   - ä¿®æ”¹åº”è§¦å‘å¤±æ•ˆçš„ç‰¹å®šæ–‡ä»¶

3. **æ£€æŸ¥æ–‡ä»¶æ”¾ç½®ï¼š**
   - ç¡®ä¿`COPY`å‘½ä»¤é¡ºåºæ­£ç¡®
   - ä¾èµ–åº”åœ¨åº”ç”¨ä»£ç ä¹‹å‰å¤åˆ¶

**Section sources**
- [CACHE_TROUBLESHOOTING.md](file://CACHE_TROUBLESHOOTING.md)
- [DOCKER_CACHE_IMPROVEMENTS_2024.md](file://documents/DOCKER_CACHE_IMPROVEMENTS_2024.md)
- [CACHE_OPTIMIZATION_GUIDE.md](file://documents/CACHE_OPTIMIZATION_GUIDE.md)

## SpaCyæ¨¡å‹ç¦»çº¿å®‰è£…é—®é¢˜

### é—®é¢˜æè¿°

è¿è¡ŒDockerå®¹å™¨æ—¶ï¼ŒKokoro TTSæœåŠ¡åˆå§‹åŒ–å¤±è´¥ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```
âŒ Pipeline creation failed: HTTPSConnectionPool(host='raw.githubusercontent.com', port=443): 
Max retries exceeded with url: /explosion/spacy-models/master/compatibility.json 
(Caused by SSLError(SSLEOFError(8, '[SSL: UNEXPECTED_EOF_WHILE_READING] EOF occurred in violation of protocol (_ssl.c:1007)')))
```

### æ ¹æœ¬åŸå› 

`kokoro`åŒ…ä¾èµ–äº`misaki`è¿›è¡ŒG2Pï¼ˆå­—ç´ åˆ°éŸ³ç´ ï¼‰è½¬æ¢ï¼Œè€Œ`misaki`åˆéœ€è¦SpaCyè‹±æ–‡æ¨¡å‹`en_core_web_sm`ã€‚è¯¥æ¨¡å‹æœªé¢„å®‰è£…åœ¨Dockeré•œåƒä¸­ï¼Œå¯¼è‡´åº”ç”¨åœ¨è¿è¡Œæ—¶å°è¯•ä¸‹è½½ã€‚

åœ¨ç”Ÿäº§/å—é™ç½‘ç»œç¯å¢ƒä¸­ï¼Œæ­¤è¿è¡Œæ—¶ä¸‹è½½ä¼šå› ä»¥ä¸‹åŸå› å¤±è´¥ï¼š
- SSL/TLSè¿æ¥é—®é¢˜
- ç½‘ç»œé™åˆ¶
- é˜²ç«å¢™ç­–ç•¥
- ç¦»çº¿éƒ¨ç½²è¦æ±‚

### è§£å†³æ–¹æ¡ˆ

åœ¨Dockeræ„å»ºè¿‡ç¨‹ä¸­é¢„å®‰è£…SpaCyæ¨¡å‹ï¼Œé€šè¿‡åœ¨Dockerfileä¸­æ·»åŠ ä»¥ä¸‹æ­¥éª¤ï¼š

```dockerfile
# é¢„å®‰è£…SpaCyè‹±æ–‡æ¨¡å‹ï¼ˆKokoroçš„misaki G2Pæ‰€éœ€ï¼‰
# è¿™å¯ä»¥é˜²æ­¢åœ¨ç¦»çº¿/å—é™ç¯å¢ƒä¸­è¿è¡Œæ—¶çš„ä¸‹è½½å°è¯•
RUN ${KOKORO_VENV}/bin/python -m spacy download en_core_web_sm
```

æ­¤å‘½ä»¤ï¼š
1. åœ¨æ„å»ºæ—¶ï¼ˆç½‘ç»œå¯ç”¨æ—¶ï¼‰ä¸‹è½½`en_core_web_sm`æ¨¡å‹
2. å°†å…¶å®‰è£…åˆ°Pythonè™šæ‹Ÿç¯å¢ƒä¸­
3. ä½¿å…¶åœ¨è¿è¡Œæ—¶å¯ç¦»çº¿ä½¿ç”¨

### å®ç°ç»†èŠ‚

**ä¿®æ”¹æ–‡ä»¶**: `Dockerfile`

**ä½ç½®**: åœ¨å®‰è£…Kokoroä¾èµ–åï¼ˆçº¦ç¬¬152è¡Œï¼‰

**æ„å»ºå½±å“**: 
- å¢åŠ çº¦12MBé•œåƒå¤§å°
- å¢åŠ æ„å»ºæ—¶é—´çº¦10-15ç§’
- æ„å»ºæ—¶éœ€è¦äº’è”ç½‘è®¿é—®ï¼ˆDockeræ„å»ºçš„æ ‡å‡†è¦æ±‚ï¼‰

### éªŒè¯

åœ¨ä½¿ç”¨æ­¤ä¿®å¤é‡å»ºDockeré•œåƒåï¼š

1. SpaCyæ¨¡å‹å°†æ†ç»‘åœ¨é•œåƒä¸­
2. Kokoro TTSå°†åœ¨æ— ç½‘ç»œè®¿é—®çš„æƒ…å†µä¸‹æˆåŠŸåˆå§‹åŒ–
3. G2Pç®¡é“å°†ç¦»çº¿å·¥ä½œ
4. ä¸å†å‘ç”Ÿè¿è¡Œæ—¶ä¸‹è½½å°è¯•

**Section sources**
- [SPACY_MODEL_FIX.md](file://documents/SPACY_MODEL_FIX.md)
- [Dockerfile](file://Dockerfile)