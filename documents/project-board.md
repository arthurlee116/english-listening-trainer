# 工作流与功能看板

## To-Do
- [ ] 建立数据库驱动的语言切换体系  
      - `users` 表新增语言偏好字段（默认中文），实现"仅显示当前语言"渲染逻辑  
      - 右上角新增纯图标地球切换器（无文字/tooltip），切换后即时刷新所有双语文案  
      - 语言偏好需写回数据库并在登录流程中自动应用，复用现有 i18n 能力
- [ ] 改造首页为可折叠左侧导航布局  
      - 左栏收纳原标题区域所有入口，点击折叠/展开并采用苹果风格弹性动画  
      - 移动端同样展示侧栏，展开时覆盖主内容并提供易触控关闭操作  
      - 缩小主标题/宣传语排版，确保在新布局下层级与可访问性良好

## In Progress
- [ ] （暂无）

## Review
- [ ] （留空，提交 PR 后填入）

## Done
- [x] 2025-10-25 **移除专项练习模式**
  - 删除 `lib/specialized-preset-storage.ts`、`lib/focus-metrics.ts`、`lib/focus-metrics-cache.ts` 专项模式服务文件
  - 从 `app/page.tsx` 移除专项模式状态、hooks、事件处理函数和API调用中的focusAreas参数
  - 简化 `hooks/use-practice-setup.ts`,移除专项模式参数和语言切换回调
  - 从 `components/home/practice-configuration.tsx` 移除专项练习UI组件和相关接口
  - 隐藏 `components/history-panel.tsx` 和 `components/results-display.tsx` 中的专项模式显示区块
  - 跳过 `tests/e2e/scenarios/complete-user-journey.spec.tsx` 中的专项练习测试
  - 更新 `tests/fixtures/exercises/sample-exercises.ts`,将helper函数标记为已废弃
  - API保持向后兼容: `/api/practice/save` 保留可选的focusAreas/focusCoverage参数以兼容历史数据
  - 保留Focus Area类型定义供其他功能使用,翻译文件保持完整以免破坏历史数据展示
  - 构建验证通过,无TypeScript类型错误
- [x] 2025-10-25 **彻底移除快捷键功能**
  - 删除 `lib/shortcuts.ts`、`hooks/use-hotkeys.ts`、`components/shortcut-help-dialog.tsx` 快捷键相关文件
  - 从 `app/page.tsx` 移除快捷键导入、状态、处理函数和 UI 组件（包括 Keyboard 图标和快捷键按钮）
  - 从 `lib/i18n/translations/common.json` 和 `components.json` 移除所有 `shortcuts.*` 相关翻译键
  - 删除 `tests/unit/hooks/use-hotkeys.test.ts` 测试文件
  - 清理 localStorage 中 `english-listening-shortcuts-*` 相关存储键的使用
  - 构建检查通过，无 TypeScript 类型错误和未使用引用警告
  - 界面仅保留点击/触控交互，不再显示任何快捷键相关内容
- [x] 2025-10-25 **下线练习模板系统并清理本地缓存**
  - 删除 `hooks/use-practice-templates.ts` 和 `lib/template-storage.ts` 模板存储模块
  - 从 `app/page.tsx` 移除模板相关的 hook 调用和状态管理
  - 从 `components/home/practice-configuration.tsx` 移除模板卡片 UI、保存/应用/重命名/删除功能
  - 从 `lib/types.ts` 删除 `PracticeTemplate` 接口定义
  - 从 `lib/i18n/translations/pages.json` 清理模板相关翻译键
  - 删除 `tests/unit/hooks/use-practice-templates.test.ts` 测试文件
  - 在应用初始化时自动清空 `localStorage` 中的 `english-listening-templates` 键
  - 验证核心练习流程（配置、生成、音频、题目）在无模板功能下完整可用
- [x] 2025-10-18 **主页练习流模块化与音频控制解耦完成**
  - `app/page.tsx` 精简为壳组件，改由 `components/home/practice-configuration.tsx`、`practice-workspace.tsx`、`authentication-gate.tsx` 组合驱动
  - 新增 `hooks/use-practice-setup.ts` 与 `hooks/use-practice-templates.ts` 管理练习模板/专项模式状态，补充对应单元测试
  - 创建 `components/audio-player/AudioPlayer.tsx` 与 `hooks/use-audio-player.ts`，实现音频播放控制抽象并扩充测试覆盖
- [x] 2025-10-18 **GPU TTS 单栈切换与音频路由流式化完成**
  - 删除 `lib/kokoro-service.ts`，`app/api/tts/route.ts|route-optimized.ts` 全量改用 `kokoroTTSGPU`，并在 `README.md` / `CLAUDE.md` 同步说明
  - `app/api/audio/[filename]/route.ts` 重写 Range 解析与响应，统一音频响应头并基于 `createReadStream` 提供流式分发
  - 新增 `tests/integration/api/audio-route.spec.ts` 验证整段、分段、后缀与 416 情形，保障路由兼容多种播放器
- [x] 2025-10-16 **音频播放与分块体验优化**
  - `app/api/audio/[filename]/route.ts` 支持 HTTP Range 请求，播放器拖拽后可无缝续播
  - `lib/audio-utils.ts` 调整 WAV chunk 解析逻辑，移除 10MB 上限并校准大文件元数据
  - `kokoro_local/text_chunker.py` 引入按单词优先的分块策略，避免长词被硬性截断
- [x] 2025-10-15 **AI 生成服务结构化与代理容错上线**
  - 创建 `lib/ark-helper.ts`、`lib/ai/cerebras-client-manager.ts`、`lib/ai/telemetry.ts`，集中管理 Cerebras/Ark 调用、代理探活与重试遥测
  - 新增 `lib/ai/request-preprocessor.ts`、`lib/ai/retry-strategy.ts`、`lib/ai/prompt-templates.ts`、`lib/ai/schemas.ts`、`lib/ai/transcript-expansion.ts`，支撑覆盖率自适应重试与 JSON Schema 解析
  - `/app/api/ai/topics|transcript|questions|grade|expand` 全部改写为 `invokeStructured()` 管道，接入限流熔断、标签覆盖率评估及扩写回退路径
  - `lib/monitoring.ts` 接入最新遥测与 Cerebras 健康检查，`lib/config-manager.ts` 支持 AI 参数配置
- [x] 2025-10-13 **Scripts directory精简完成**
  - 删除 70+ 旧部署/诊断脚本，仅保留 `backup.sh`、`restore.sh`、`setup-kokoro.sh`
  - 更新 `package.json`、Docker Compose 与部署文档改用手动命令
  - 调整状态/快照文档，标记缓存脚本已归档，避免误用硬编码凭据
- [x] 2025-10-12 **Phase 4: 远程服务器缓存预热完成**
  - 创建 `scripts/remote-cache-prewarm.sh` 实现多级缓存预热
  - 创建 `scripts/verify-cache-layers.sh` 验证缓存层完整性
  - 修改 `scripts/deploy-from-ghcr.sh` 集成缓存预热步骤（2025-10-13 起已归档）
  - 统一 `Dockerfile.optimized` NODE_MAJOR 版本为 20
  - 明确两个 Dockerfile 用途并添加注释
  - 详细记录：`documents/workflow-snapshots/remote-cache-prewarm-snapshot.md`
  - （2025-10-13 更新：脚本已归档，改为直接使用 docker pull + docker compose 流程）
- [x] 2025-10-07 **Phase 4: 完善部署文档与缓存管理指南**
  - 新增《CACHE_MANAGEMENT_GUIDE.md》定义缓存刷新/季度切换/配额监控
  - 创建《SERVER_DEPLOYMENT_TEST_GUIDE.md》，补充远程缓存预热与部署排查
  - 创建《WORKFLOW_TESTING_GUIDE.md》，记录预热/主 workflow 验证与 Summary 读取
  - 同步状态表、快照、路线图，完成 CI 缓存优化路线图
- [x] 2025-10-07 **Phase 3: 调整主 workflow 使用多级 cache-from**
  - `.github/workflows/build-and-push.yml` 采用 GHCR `cache-base/cache-python/cache-node/cache-builder` 链
  - 移除 `actions/cache` 及本地缓存目录迁移步骤，仅推送 `cache-builder`
  - 增加 `df -h` + 4GB 阈值检查，构建日志 `CACHED` 统计写入 Summary
  - workflow_dispatch 新增 `rebuild-deps-cache` 输入，用于提醒触发 `prewarm-deps.yml`
  - Summary 输出命中行数与后续建议
- [x] 2025-10-07 **Phase 2: 依赖缓存预热工作流**
  - 创建 `prewarm-deps.yml`（三层缓存：base/python/node）
  - 季度版本标签：2025Q4（固定策略）
  - 跳过 builder 层推送（避免体积失控）
  - 每周一自动执行 + workflow_dispatch 手动触发
  - 磁盘空间监控：<4GB 时失败告警
  - Summary 报告：标签表格 + 使用指南
- [x] 2025-10-07 **Phase 1: 基础镜像内刊化（含 cuDNN8 标签修复）**
  - 推送 CUDA 基础镜像至 GHCR（digest: sha256:b2c52e...c12faa34）
  - **修复标签命名**：保留 `cudnn8` 后缀 → `12.1.1-cudnn8-runtime-ubuntu22.04`
  - 验证 cuDNN 版本：libcudnn8 8.9.0.131 ✅
  - 更新 `Dockerfile` 和 `Dockerfile.optimized` FROM 行使用正确标签
  - 配置远程服务器 Docker 镜像加速器
  - 更新项目文档（status/board/snapshot/roadmap）
- [x] 2025-10-06 **关键 Bug 修复：PR #6-9**
  - 修复环境变量空字符串路径错误（`kokoro_wrapper.py:122-140`）
  - 重命名 `kokoro-local/` → `kokoro_local/`（Python 模块兼容性）
  - 修复 CI 依赖缺失问题（添加 ImportError 捕获，`selftest/__main__.py:56-68`）
  - 更新所有路径引用（30+ 文件，包括 TypeScript、YAML、Markdown）
  - 推送修复到 PR #6 (7542a2d), #7 (9ecacec), #8 (a431f15), #9 (e2a9c5d)
- [x] 2025-10-06 **阶段 4：最终文档同步**
  - 更新 `CLAUDE.md` 添加 Kokoro CLI 使用说明
  - 添加 TTS Setup 部分的 CLI 自检命令示例
  - 更新 Python Integration 章节说明新模块结构
  - 添加 `KOKORO_LOCAL_MODEL_PATH` 环境变量文档
  - 补充生产环境 TTS 验证步骤
  - 验证：文档一致性 ✅
- [x] 2025-10-06 **阶段 3：GitHub Actions 集成自检步骤**
  - 修改 `.github/workflows/build-and-push.yml` 添加 Kokoro 自检步骤
  - 添加 Python 3.11 环境配置（使用 actions/setup-python@v5）
  - 安装 PyYAML 依赖
  - 运行 `python -m kokoro_local.selftest --config configs/default.yaml --format json --skip-on-missing-model`
  - 上传测试报告为 artifact（保留 30 天）
  - 添加测试结果到 GitHub Actions Summary
  - 验证：YAML 语法 ✅
- [x] 2025-10-06 **阶段 2：实现 CLI 自检脚本**
  - 创建 `kokoro_local/selftest/` 模块结构
  - 创建配置文件 `configs/default.yaml`（CPU）和 `configs/gpu.yaml`（GPU）
  - 实现 `selftest/__main__.py` 核心逻辑（300+ 行）
  - 支持 Markdown（默认）和 JSON 输出格式
  - 支持 `--skip-on-missing-model` 参数
  - 集成性能指标输出（合成时间、实时因子等）
  - 验证：Python 语法 ✅、文件结构 ✅
- [x] 2025-10-06 **代码重构：使用 kokoro-env 辅助函数消除硬编码路径**
  - 重构 4 个 TypeScript 服务文件使用 `lib/kokoro-env.ts` 辅助函数
  - 替换硬编码路径为 `resolveKokoroWrapperPath()`, `resolveKokoroPythonExecutable()`, `resolveKokoroWorkingDirectory()`, `buildKokoroPythonEnv()`
  - 修改文件：
    - `lib/kokoro-service-enhanced.ts` (导入并使用辅助函数)
    - `lib/enhanced-tts-service.ts` (导入并使用辅助函数)
    - `lib/config-manager.ts` (使用辅助函数设置默认 TTS 路径)
    - `app/api/health/route.ts` (使用辅助函数进行路径检查)
  - 优势：单一数据源、环境变量覆盖支持、自动 venv 检测、跨平台兼容性
  - 验证：ESLint 通过 ✅
- [x] 2025-10-06 **阶段 1：抽离 Kokoro 文本分块模块并统一 wrapper 入口**
  - 创建 `kokoro_local/text_chunker.py`
  - 重构 `kokoro_wrapper.py` 使用新模块
  - 强化离线加载逻辑（环境变量 `KOKORO_LOCAL_MODEL_PATH`）
  - 迁移历史脚本到 `legacy/` 目录
  - 更新 `lib/kokoro-env.ts` 引用新 wrapper
  - 验证：Python 语法 ✅、Node 层引用 ✅、lint/test 通过 ✅
- [x] 2025-10-06 清理冗余文档：删除根目录 8 个历史总结文件，删除 documents/ 目录 25 个历史文件，保留核心文档结构（状态、看板、快照、路线图）。
