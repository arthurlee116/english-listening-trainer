// Prisma Schema - 英语听力训练应用 (用户认证版本)
// 支持多数据库适配器: SQLite, PostgreSQL, MySQL

generator client {
  provider = "prisma-client-js"
}

// 数据库配置 - 根据 DATABASE_URL 自动检测数据库类型
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 用户表 - 邮箱密码认证系统
// ==========================================
model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String    // bcrypt 加密
  name      String?
  isAdmin   Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  
  // 关联关系
  practiceSessions PracticeSession[]
  
  // 优化索引
  @@index([isAdmin]) // 管理员查询优化
  @@index([createdAt]) // 用户注册时间统计
  @@map("users")
}

// ==========================================
// 练习会话表 - 存储用户练习数据
// ==========================================
model PracticeSession {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  exerciseData String   @map("exercise_data") // JSON 格式的完整练习数据
  difficulty   String   // CEFR 级别 (A1, A2, B1, B2, C1, C2)
  language     String   @default("en-US") // 听力语言
  topic        String   // 练习主题
  accuracy     Float?   // 准确率 (0-1)
  score        Int?     // 总分
  duration     Int?     // 练习时长(秒)
  createdAt    DateTime @default(now()) @map("created_at")
  
  // 关联关系
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 优化索引 - 针对常见查询模式
  @@index([userId, createdAt(sort: Desc)]) // 用户练习历史查询（按时间倒序）
  @@index([createdAt(sort: Desc)]) // 全局最新练习查询
  @@index([difficulty, createdAt]) // 按难度统计分析
  @@index([language, createdAt]) // 按语言统计分析
  @@index([accuracy]) // 按准确率统计
  @@index([userId, difficulty, createdAt]) // 用户特定难度练习查询
  @@map("practice_sessions")
}